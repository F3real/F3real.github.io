
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="F3real" />
        <meta name="keywords" content="crackme,elf" />
        <meta name="description" content="Solution to W3challs striptease challenge" />


    <title>W3challs striptease - EnSec blog</title>

    <link href="https://f3real.github.io/theme/css/combined.css" rel="stylesheet" />

    <!-- Feeds -->
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="https://f3real.github.io" title="EnSec blog" class="collapsed">
            <span class="fas fa-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="https://f3real.github.io/archives.html" title="Recent Articles" class="collapsed">
            <span class="fas fa-th-list"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fas fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github"><i class="fab fa-github-square padding-small"></i></a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin"><i class="fab fa-linkedin padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fas fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </nav>
        <nav id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="https://f3real.github.io/">
                            <span class="fas fa-home padding-small"></span>
                            EnSec blog
                    </a>
                </li>
                    <li>
                        <a href="https://f3real.github.io/archives.html">
                            <span class="fas fa-th-list padding-small"></span>
                            Archives
                        </a>
                    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fas fa-users padding-small"></i>
                        Contact
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github">
                            <i class="fab fa-github-square padding-small"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin">
                            <i class="fab fa-linkedin padding-small"></i>
                            Linkedin
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li class="panel anti-panel"><ul id="collapse-pages" class="sidebar_submenu collapse ">
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fas fa-folder-open padding-small"></i>
                        Categories
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li >
                        <a href="https://f3real.github.io/category/ctf.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            ctf
                            <span class="badge badge-secondary float-right categorybadge">28</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/misc.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            misc
                            <span class="badge badge-secondary float-right categorybadge">15</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="https://f3real.github.io/category/reversing.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            reversing
                            <span class="badge badge-secondary float-right categorybadge">6</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/tutorial.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            tutorial
                            <span class="badge badge-secondary float-right categorybadge">5</span>
                        </a>
                    </li>
                </ul></li>
            </ul>
        </nav>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <button onclick="toggleMenu();return false;" class="btn btn-primary" id="menu-toggle">
            <span id="right-arrow" class="fas fa-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="fas fa-chevron-left" title="minimize sidebar"></span>
        </button>
       <!-- /open/close sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-10">
                <header class="page-header">
                    <h1>
                        <a href="https://f3real.github.io/w3challs_striptease.html"
                           rel="bookmark"
                           title="Permalink to W3challs striptease">
                            W3challs striptease
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2020-02-16T10:02:00+01:00"> Sun 16 February 2020</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="https://f3real.github.io/category/reversing.html">reversing</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="https://f3real.github.io/tag/crackme.html">crackme</a> /                 <a href="https://f3real.github.io/tag/elf.html">elf</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10">
                <div class="entry-content">
                    <p>In this post, we will take a quick look at one of the simpler reversing challenges from W3challs, striptease.</p>
<p>If we open it in <code>radare2</code> and look at the entry function we see:</p>
<div class="highlight"><pre><span></span><code> 0x08048075      be00000000     mov esi, 0
│           ; CODE XREF from fcn.08048075 @ +0x46
│       ┌─&gt; 0x0804807a      8b1dd0900408   mov ebx, dword [segment.LOAD1] ; [0x80490d0:4]=188
│       ╎   0x08048080      83c303         add ebx, 3
│       ╎   0x08048083      391dd4900408   cmp dword [0x80490d4], ebx  ; [0x80490d4:4]=255
│      ┌──&lt; 0x08048089      7d06           jge 0x8048091
│      │╎   0x0804808b      2b1dd4900408   sub ebx, dword [0x80490d4]  ; [0x80490d4:4]=255
│      │╎   ; CODE XREF from fcn.08048075 @ 0x8048089
│      └──&gt; 0x08048091      b899800408     mov eax, 0x8048099
└       ╎   0x08048096      ffe0           jmp eax
        ╎   0x08048098      83891dd09004.  or dword [ecx + 0x490d01d], 8
        ╎   0x0804809f      bf5a910408     mov edi, 0x804915a
        ╎   0x080480a4      8b0435d89004.  mov eax, dword [esi + 0x80490d8]
        ╎   0x080480ab      31d8           xor eax, ebx
        ╎   0x080480ad      890435d89004.  mov dword [esi + 0x80490d8], eax
        ╎   0x080480b4      46             inc esi
        ╎   0x080480b5      81fe81000000   cmp esi, 0x81               ; 129
        └─&lt; 0x080480bb      75bd           jne 0x804807a               ; fcn.08048075+0x5
        ┌─&lt; 0x080480bd      e916100000     jmp 0x80490d8
        │   0x080480c2      b801000000     mov eax, 1
        │   0x080480c7      bb00000000     mov ebx, 0
        │   0x080480cc      cd80           int 0x80
</code></pre></div>

<p>This is the only function in binary that we can immediately inspect, so we need to find what does it do. If we look closely, we see that it is a simple loop performing XOR decryption with incrementing key. After loop finishes, control will jump to decrypted code. We can dynamically debug binary and see the decrypted code or we can write a simple python script to do it for us. </p>
<p>The flag is a hardcoded string in part of code that gets decrypted.</p>
<p>Solution:</p>
<div class="highlight"><pre><span></span><code><span class="n">TARGET_BYTE_OFFSET</span> <span class="o">=</span> <span class="mh">0xd8</span>
<span class="n">REPETITIONS</span> <span class="o">=</span> <span class="mh">0x81</span>  <span class="c1"># 129</span>
<span class="n">INCREMENT</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">TARGET_BIN</span> <span class="o">=</span> <span class="s1">&#39;striptease-1be7d788d5e8de3ea92166b9d9fdbd5ce62d97e76136675c3ef12ef7b3db3602&#39;</span>
<span class="n">TARGET_BIN_MODIFIED</span> <span class="o">=</span> <span class="s1">&#39;striptease-modified&#39;</span>

<span class="c1"># load encrypted part of binary:</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TARGET_BIN</span><span class="p">,</span> <span class="s1">&#39;rb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">target</span><span class="p">:</span>
    <span class="n">target</span><span class="o">.</span><span class="n">seek</span><span class="p">(</span><span class="n">TARGET_BYTE_OFFSET</span><span class="p">)</span>
    <span class="n">encrypted_instructions</span> <span class="o">=</span> <span class="nb">bytearray</span><span class="p">(</span><span class="n">target</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">REPETITIONS</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Length of encrypted part of binary: </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">encrypted_instructions</span><span class="p">)</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># decode instructions</span>
    <span class="n">esi</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ebx</span> <span class="o">=</span> <span class="mh">0xbc</span>
    <span class="k">while</span> <span class="n">esi</span> <span class="o">!=</span> <span class="n">REPETITIONS</span><span class="p">:</span>
        <span class="n">ebx</span> <span class="o">=</span> <span class="n">ebx</span> <span class="o">+</span> <span class="n">INCREMENT</span>
        <span class="k">if</span> <span class="n">ebx</span> <span class="o">&gt;=</span> <span class="mi">255</span><span class="p">:</span>
            <span class="n">ebx</span> <span class="o">-=</span> <span class="mi">255</span>
        <span class="n">encrypted_instructions</span><span class="p">[</span><span class="n">esi</span><span class="p">]</span> <span class="o">^=</span> <span class="n">ebx</span>
        <span class="n">esi</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">TARGET_BIN_MODIFIED</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">res</span><span class="p">:</span>
        <span class="n">res</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">encrypted_instructions</span><span class="p">)</span>
</code></pre></div>
                </div>
                <footer class="text-right">
                    <p>- F3real</p>
                </footer>
    <div id="show-comments" class="span7 text-center">
        <a href="https://f3real.github.io/w3challs_striptease.html#disqus_thread"
          data-disqus-identifier="w3challs_striptease"
        class="btn btn-primary twitchy-background">Show Comments</a>
    </div>
    <section id="comments" class="comments hidden">
        <hr/>
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>
            </div>
        </div>
    </article>
</section>
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-10 text-center">
            <p><small>
                Built by <a href="http://docs.getpelican.com/en/latest">Pelican</a> / <a href="https://github.com/F3real/pelican-twitchy">pelican-twitchy</a>
                &middot;                    &copy; 2024 F3real
            </small></p>
        </div>
    </div>
</footer>            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->

<!-- disqus -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'https-f3real-github-io'; // required: replace example with your forum shortname

            var disqus_identifier = 'w3challs_striptease';
        var disqus_url = 'https://f3real.github.io/w3challs_striptease.html';

    var disqus_config = function () {
        this.language = "en";
    };

        var commentsDiv = document.getElementById('show-comments');
        commentsDiv.onclick = function() {
            /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
            this.style.display = 'none';        
        };
</script>
<!-- /disqus -->
    <script>
        const wrapper = document.getElementById('wrapper');
        const sidebarBig = document.getElementById('sidebar-wrapper');
        const sidebarSmall = document.getElementById('sidebar-wrapper-small');

        const triggers = Array.from(document.querySelectorAll('[data-toggle="collapse"]'));
        for (var i = 0; i < triggers.length; i++) { 
            triggers[i].addEventListener('click', (ev) => {
                const elm = ev.currentTarget;    
                ev.preventDefault();
                const selector = elm.getAttribute('href').replace('#','');
                elm.classList.toggle('collapsed');
                document.getElementById(selector).classList.toggle('show');
            }, false);
        } 

        function showBigNav() {;
            sidebarBig.style.display = 'block';
            sidebarSmall.style.display = 'none';
        }
        function showSmallNav() {
            sidebarBig.style.display = 'none';
            sidebarSmall.style.display = 'block';
        }

        const mediaQuery = window.matchMedia('(min-width:768px)');
        mediaQuery.onchange = e => {
            if (wrapper.classList.contains('toggled')) {
                    wrapper.classList.remove('toggled');
            } else {
                if (e.matches) {
                    showBigNav();
                } else {
                    showSmallNav();
                }
            }
        }

        function setNavbar() {
            var condition = wrapper.classList.contains('toggled');
            if (!mediaQuery.matches) {
                condition = !condition;
            }
            if (condition) {
                showSmallNav();
            } else {
                showBigNav();
            }
        }

        function toggleMenu(){
            wrapper.classList.toggle('toggled');
            setNavbar();
        }

        window.onload = setNavbar;
    </script>
	<script data-goatcounter="https://f3real.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>