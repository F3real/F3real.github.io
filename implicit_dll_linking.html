
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
        <meta name="author" content="F3real" />
        <meta name="keywords" content="windows,dll,lib" />
        <meta name="description" content="How to implicitly link dll" />


    <title>Implicit dll linking - EnSec blog</title>

    <link href="https://f3real.github.io/theme/css/combined.css" rel="stylesheet" />

    <!-- Feeds -->
</head>
<body data-spy="scroll" data-target="#scrollspy">
    <div id="wrapper">
        <!-- Sidebar -->
        <nav id="sidebar-wrapper-small" class="twitchy-background">
            <ul id="accordion-small" class="sidebar-nav sidebar-nav-small">
                <li>
        <a href="https://f3real.github.io" title="EnSec blog" class="collapsed">
            <span class="fas fa-home"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
        <a href="https://f3real.github.io/archives.html" title="Recent Articles" class="collapsed">
            <span class="fas fa-th-list"></span>
        </a>
    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion-small" href="#collapse-social-small" title="Social" class="collapsed">
                        <i class="fas fa-users padding-small"></i>
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social-small" class="collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github"><i class="fab fa-github-square padding-small"></i></a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin"><i class="fab fa-linkedin padding-small"></i></a>
                    </li>
                </ul></li>
                <li class="nav-divider"></li>
                <li>
        <a href="#" title="Back to top" class="collapsed">
            <span class="fas fa-arrow-up"></span>
        </a>
    </li>
            </ul>
        </nav>
        <nav id="sidebar-wrapper" class="twitchy-background">
            <ul id="accordion" class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="https://f3real.github.io/">
                            <span class="fas fa-home padding-small"></span>
                            EnSec blog
                    </a>
                </li>
                    <li>
                        <a href="https://f3real.github.io/archives.html">
                            <span class="fas fa-th-list padding-small"></span>
                            Archives
                        </a>
                    </li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-social">
                        <i class="fas fa-users padding-small"></i>
                        Contact
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-social" class="sidebar_submenu collapse ">
                    <li>
                        <a href="https://github.com/F3real" title="Github">
                            <i class="fab fa-github-square padding-small"></i>
                            Github
                        </a>
                    </li>
                    <li>
                        <a href="https://www.linkedin.com/in/stefan-ili%C4%87-61a004111" title="Linkedin">
                            <i class="fab fa-linkedin padding-small"></i>
                            Linkedin
                        </a>
                    </li>
                </ul></li>
                
                <li class="nav-divider"></li>
                <li class="panel anti-panel"><ul id="collapse-pages" class="sidebar_submenu collapse ">
                </ul></li>
                <li class="nav-divider"></li>
                <li>
                    <a data-toggle="collapse" data-parent="#accordion" href="#collapse-categories">
                        <i class="fas fa-folder-open padding-small"></i>
                        Categories
                    </a>
                </li>
                <li class="panel anti-panel"><ul id="collapse-categories" class="sidebar_submenu collapse ">
                    <li >
                        <a href="https://f3real.github.io/category/ctf.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            ctf
                            <span class="badge badge-secondary float-right categorybadge">28</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/misc.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            misc
                            <span class="badge badge-secondary float-right categorybadge">15</span>
                        </a>
                    </li>
                    <li >
                        <a href="https://f3real.github.io/category/reversing.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            reversing
                            <span class="badge badge-secondary float-right categorybadge">6</span>
                        </a>
                    </li>
                    <li class="active">
                        <a href="https://f3real.github.io/category/tutorial.html">
                            <i class="fas fa-folder-open padding-small"></i>
                            tutorial
                            <span class="badge badge-secondary float-right categorybadge">5</span>
                        </a>
                    </li>
                </ul></li>
            </ul>
        </nav>
        <!-- /#sidebar-wrapper -->
        <!-- open/close sidebar -->
        <button onclick="toggleMenu();return false;" class="btn btn-primary" id="menu-toggle">
            <span id="right-arrow" class="fas fa-chevron-right"  title="expand sidebar"></span>
            <span id="left-arrow" class="fas fa-chevron-left" title="minimize sidebar"></span>
        </button>
       <!-- /open/close sidebar -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
            <div class="container-fluid">
<section id="content">
    <article>
        <div class="row">
            <div class="col-lg-10">
                <header class="page-header">
                    <h1>
                        <a href="https://f3real.github.io/implicit_dll_linking.html"
                           rel="bookmark"
                           title="Permalink to Implicit dll linking">
                            Implicit dll linking
                        </a>
                        <small>
<div class="post-info">
    <div class="publish-info-block">
        <small>
            <span class="published">
                <i class="fa fa-calendar padding-small"></i><time datetime="2019-04-14T10:01:00+02:00"> Sun 14 April 2019</time>
            </span>
            <span class="category">
                <i class="fa fa-folder-open padding-small"></i><a href="https://f3real.github.io/category/tutorial.html">tutorial</a>
            </span>
            <span class="tags">
                <i class="fa fa-tags padding-small"></i>
                <a href="https://f3real.github.io/tag/windows.html">windows</a> /                 <a href="https://f3real.github.io/tag/dll.html">dll</a> /                 <a href="https://f3real.github.io/tag/lib.html">lib</a>            </span>
        </small>
    </div>
</div><!-- /.post-info -->                        </small>
                    </h1>
                </header>
            </div>
        </div>
        <div class="row">
            <div class="col-lg-10">
                <div class="entry-content">
                    <p>In windows, we can link dlls in two different ways to our program, implicitly and explicitly.</p>
<p>In explicit linking, during runtime of our program, we make a call to <code>LoadLibrary</code> or similar function to obtain module handle.</p>
<p>In implicit linking, we link our program to <code>.lib</code> file and include headers containing declarations of exported data and functions.</p>
<p>Now interestingly Windows has two types of <code>.lib</code> files. Usually, they represent static libraries and linking them copies code stored in them to our executable. The second type of <code>.lib</code> files in Windows are import libraries that contain only stub code of dll functions and make our executable load required dll at startup.</p>
<p>So how to create required import <code>.lib</code> file from dll?</p>
<p>First, we have to get a list of exported functions from dll. For this, we can use <code>dumpbin</code> utility included with visual studio.
In Visual Studio 2017 path to dumpbin is:</p>
<div class="highlight"><pre><span></span><code>\Microsoft Visual Studio\2017\Community\VC\Tools\MSVC\14.13.26128\bin\Hostx64\x64\dumpbin.exe
</code></pre></div>

<p>To use dumpbin:</p>
<div class="highlight"><pre><span></span><code>PS&gt;dumpbin.exe /exports C:\Windows\SysWOW64\netapi32.dll
Microsoft (R) COFF/PE Dumper Version 14.13.26132.0
Copyright (C) Microsoft Corporation.  All rights reserved.


Dump of file C:\Windows\SysWOW64\netapi32.dll

File Type: DLL

  Section contains the following exports for NETAPI32.dll

    00000000 characteristics
    171B77B1 time date stamp
        0.00 version
           1 ordinal base
         296 number of functions
         296 number of names

    ordinal hint RVA      name

          1    0          DavAddConnection (forwarded to ext-ms-win-rdr-davhlpr-l1-1-0.DavAddConnection)
          2    1          DavDeleteConnection (forwarded to ext-ms-win-rdr-davhlpr-l1-1-0.DavDeleteConnection)
          3    2          DavFlushFile (forwarded to ext-ms-win-rdr-davhlpr-l1-1-0.DavFlushFile)
          4    3          DavGetExtendedError (forwarded to ext-ms-win-rdr-davhlpr-l1-1-0.DavGetExtendedError)
          ....
          long list of exported functions
          ....
</code></pre></div>

<p>The hint is used by the loader as an attempt to find the location of function faster.
Now to create lib file we have first to create an export definition file (<code>.def</code>). The standard form of def file is:</p>
<div class="highlight"><pre><span></span><code>LIBRARY   ourdll.dll
EXPORTS
   funcName1
   funcName2
</code></pre></div>

<p>To generate lib file itself we use lib.exe utility (located in the same folder as dumpbin). Let's do this on example <code>.def</code> file:</p>
<div class="highlight"><pre><span></span><code>PS&gt; cat mylib.def
LIBRARY   netapi32.dll
EXPORTS
   DavAddConnection
   DavDeleteConnection

PS&gt; lib.exe /def:mylib.def /machine:x64
Microsoft (R) Library Manager Version 14.13.26132.0
Copyright (C) Microsoft Corporation.  All rights reserved.

   Creating library mylib.lib and object mylib.exp
</code></pre></div>

<p>Executables linked to <code>.lib</code> files created in this way contain strings of function names exported from dll. To remove these strings we can use ordinal import. In <code>.def</code> files we need to add an ordinal number of function after function name (funcName1 @ordNumber).</p>
<div class="highlight"><pre><span></span><code>PS&gt; cat mylib.def
LIBRARY   netapi32.dll
EXPORTS
   DavAddConnection @1
   DavDeleteConnection @2

PS&gt; lib.exe /def:mylib.def /out:mylib2.lib /machine:x64
Microsoft (R) Library Manager Version 14.13.26132.0
Copyright (C) Microsoft Corporation.  All rights reserved.

   Creating library mylib2.lib and object mylib2.exp  
</code></pre></div>

<p>The ordinal represents the position of the function's address pointer in the DLL Export Address table. Ordinal values for Windows API functions don't have to be exactly the same between different Windows versions so they are not the most reliable way to import functions from dlls. But on the upside, this way of importing also provides a slight performance increase.</p>
                </div>
                <footer class="text-right">
                    <p>- F3real</p>
                </footer>
    <div id="show-comments" class="span7 text-center">
        <a href="https://f3real.github.io/implicit_dll_linking.html#disqus_thread"
          data-disqus-identifier="implicit_dll_linking"
        class="btn btn-primary twitchy-background">Show Comments</a>
    </div>
    <section id="comments" class="comments hidden">
        <hr/>
        <h2>Comments</h2>
        <div id="disqus_thread"></div>
        <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by
            Disqus.</a></noscript>
        <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
    </section>
            </div>
        </div>
    </article>
</section>
<footer>
    <hr>
    <div class="row">
        <div class="col-lg-10 text-center">
            <p><small>
                Built by <a href="http://docs.getpelican.com/en/latest">Pelican</a> / <a href="https://github.com/F3real/pelican-twitchy">pelican-twitchy</a>
                &middot;                    &copy; 2024 F3real
            </small></p>
        </div>
    </div>
</footer>            </div>
        </div>
        <!-- /#page-content-wrapper -->
    </div>
    <!-- /#wrapper -->

<!-- disqus -->
<script type="text/javascript">
    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
    var disqus_shortname = 'https-f3real-github-io'; // required: replace example with your forum shortname

            var disqus_identifier = 'implicit_dll_linking';
        var disqus_url = 'https://f3real.github.io/implicit_dll_linking.html';

    var disqus_config = function () {
        this.language = "en";
    };

        var commentsDiv = document.getElementById('show-comments');
        commentsDiv.onclick = function() {
            /* * * DON'T EDIT BELOW THIS LINE * * */
    (function () {
        var dsq = document.createElement('script');
        dsq.type = 'text/javascript';
        dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();
            this.style.display = 'none';        
        };
</script>
<!-- /disqus -->
    <script>
        const wrapper = document.getElementById('wrapper');
        const sidebarBig = document.getElementById('sidebar-wrapper');
        const sidebarSmall = document.getElementById('sidebar-wrapper-small');

        const triggers = Array.from(document.querySelectorAll('[data-toggle="collapse"]'));
        for (var i = 0; i < triggers.length; i++) { 
            triggers[i].addEventListener('click', (ev) => {
                const elm = ev.currentTarget;    
                ev.preventDefault();
                const selector = elm.getAttribute('href').replace('#','');
                elm.classList.toggle('collapsed');
                document.getElementById(selector).classList.toggle('show');
            }, false);
        } 

        function showBigNav() {;
            sidebarBig.style.display = 'block';
            sidebarSmall.style.display = 'none';
        }
        function showSmallNav() {
            sidebarBig.style.display = 'none';
            sidebarSmall.style.display = 'block';
        }

        const mediaQuery = window.matchMedia('(min-width:768px)');
        mediaQuery.onchange = e => {
            if (wrapper.classList.contains('toggled')) {
                    wrapper.classList.remove('toggled');
            } else {
                if (e.matches) {
                    showBigNav();
                } else {
                    showSmallNav();
                }
            }
        }

        function setNavbar() {
            var condition = wrapper.classList.contains('toggled');
            if (!mediaQuery.matches) {
                condition = !condition;
            }
            if (condition) {
                showSmallNav();
            } else {
                showBigNav();
            }
        }

        function toggleMenu(){
            wrapper.classList.toggle('toggled');
            setNavbar();
        }

        window.onload = setNavbar;
    </script>
	<script data-goatcounter="https://f3real.goatcounter.com/count"
        async src="//gc.zgo.at/count.js"></script>
</body>
</html>